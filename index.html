<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Reckoning Radar — Epstein Files Intelligence</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Roboto:ital,wght@0,400;0,500;0,700;1,400&family=Source+Sans+3:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://use.typekit.net/zzw7dfl.css">
<style>

/* ── THEME TOKENS ── */
:root {
  --bg:             #f4f1ed;
  --bg-secondary:   #f0ede7;
  --bg-card:        #f4f1ed;
  --surface:        #f4f1ed;
  --border:         rgba(0,0,0,0.08);
  --border-mid:     rgba(0,0,0,0.12);
  --border-strong:  rgba(0,0,0,0.18);
  --accent:         #1A1A1A;
  --accent-dim:     rgba(26,26,26,0.10);
  --accent-bg:      rgba(26,26,26,0.08);
  --accent-btn:     #1A1A1A;
  --accent-btn-text:#FFFFFF;
  --text-primary:   #474543;
  --text-secondary: #474543;
  --text-tertiary:  #474543;
  --confirmed:      #1A6B3C;
  --confirmed-bg:   rgba(26,107,60,0.08);
  --confirmed-border:rgba(26,107,60,0.25);
  --corroborated:   #1A5C8A;
  --corroborated-bg:rgba(26,92,138,0.08);
  --corroborated-border:rgba(26,92,138,0.25);
  --indicated:      #8A5A1A;
  --indicated-bg:   rgba(138,90,26,0.08);
  --indicated-border:rgba(138,90,26,0.25);
  --unverified:     #8A1A1A;
  --unverified-bg:  rgba(138,26,26,0.08);
  --unverified-border:rgba(138,26,26,0.25);
  --shadow-sm:      0 1px 3px rgba(0,0,0,0.06);
  --topbar-bg:      #f0ede7;
  --header-bg:      #0D0D0D;
  --header-text:    #F7F4EF;
  --redact-color:   #1A1A1A;
  --stamp-color:    rgba(180,40,40,0.18);
  --stamp-border:   rgba(180,40,40,0.55);
  --highlight:      #C8102E;
  --highlight-dim:  rgba(200,16,46,0.08);
  --highlight-mid:  rgba(200,16,46,0.2);
  --node-bg:        #1A1A1A;
  --node-text:      #F7F4EF;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'neue-haas-grotesk-display', -apple-system, sans-serif;
  background: var(--bg);
  color: var(--text-primary);
  font-size: 14px;
  line-height: 1.5;
  min-height: 100vh;
}

/* ── DESKTOP LAYOUT ── */
.app {
  display: grid;
  grid-template-columns: 210px 1fr 260px;
  grid-template-rows: 64px 1fr;
  height: 100vh;
  overflow: hidden;
}
.topbar {
  grid-column: 1/-1;
  grid-row: 1;
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 0 1.25rem;
  background: var(--topbar-bg);
  border-bottom: 1px solid var(--border);
  backdrop-filter: blur(12px);
  position: sticky;
  top: 0;
  z-index: 100;
}
.sidebar-left {
  grid-column: 1;
  grid-row: 2;
  overflow-y: auto;
  border-right: 1px solid var(--border);
  padding: 1.1rem 0.75rem;
  background: var(--bg-secondary);
}
.main {
  grid-column: 2;
  grid-row: 2;
  overflow-y: auto;
  padding: 0;
  position: relative;
}
.sidebar-right {
  grid-column: 3;
  grid-row: 2;
  overflow-y: auto;
  border-left: 1px solid var(--border);
  padding: 1rem;
  background: var(--bg);
}

/* ── TOPBAR LOGO ── */
.topbar-logo {
  flex-shrink: 0;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  line-height: 1;
  gap: 1px;
}
.logo-the {
  font-family: 'neue-haas-grotesk-display', sans-serif;
  font-weight: 300;
  font-size: 0.58rem;
  letter-spacing: 0.25em;
  text-transform: uppercase;
  color: var(--text-tertiary);
}
.logo-main {
  font-family: 'neue-haas-grotesk-display', sans-serif;
  font-weight: 700;
  font-size: 1.3rem;
  letter-spacing: -0.02em;
  color: var(--text-primary);
  white-space: nowrap;
}

.topbar-center {
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  width: 480px;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  background: var(--surface);
  border: 1px solid var(--border-strong);
  border-radius: 8px;
  padding: 0 0.75rem;
}
.search-icon { color: var(--text-tertiary); font-size: 1rem; flex-shrink: 0; }
.search-bar {
  flex: 1;
  border: none;
  background: transparent;
  color: var(--text-primary);
  font-family: 'Source Sans 3', 'Source Sans Pro', sans-serif;
  font-style: italic;
  font-size: 0.9rem;
  outline: none;
  padding: 0.5rem 0;
}
.search-bar::placeholder { color: var(--text-tertiary); font-style: italic; }

/* ── GLOBAL SEARCH DROPDOWN ── */
.global-search-wrap {
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  width: 480px;
  z-index: 9999;
}
.global-search-input-row {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  background: var(--surface);
  border: 1px solid var(--border-strong);
  border-radius: 8px;
  padding: 0 0.75rem;
  transition: border-color 0.15s, box-shadow 0.15s;
}
.global-search-input-row.active {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(26,26,26,0.07);
  border-radius: 8px 8px 0 0;
}
.global-search-dropdown {
  display: none;
  position: absolute;
  top: 100%;
  left: 0; right: 0;
  background: var(--surface);
  border: 1px solid var(--accent);
  border-top: none;
  border-radius: 0 0 10px 10px;
  box-shadow: 0 12px 40px rgba(0,0,0,0.14);
  max-height: 480px;
  overflow-y: auto;
  z-index: 9999;
}
.global-search-dropdown.open { display: block; }
.gsd-section-label {
  font-family: 'Montserrat', sans-serif;
  font-size: 0.62rem;
  font-weight: 700;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: var(--text-tertiary);
  padding: 0.65rem 1rem 0.3rem;
  border-top: 1px solid var(--border);
}
.gsd-section-label:first-child { border-top: none; }
.gsd-item {
  display: flex;
  align-items: flex-start;
  gap: 0.65rem;
  padding: 0.55rem 1rem;
  cursor: pointer;
  transition: background 0.1s;
  border-left: 2px solid transparent;
}
.gsd-item:hover, .gsd-item.focused {
  background: var(--accent-bg);
  border-left-color: var(--accent);
}
.gsd-icon {
  font-size: 0.85rem;
  margin-top: 0.1rem;
  flex-shrink: 0;
  width: 18px;
  text-align: center;
  color: var(--text-tertiary);
}
.gsd-main {
  flex: 1;
  min-width: 0;
}
.gsd-name {
  font-family: 'Montserrat', sans-serif;
  font-size: 0.8rem;
  font-weight: 600;
  color: var(--text-primary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.gsd-name mark {
  background: rgba(200,16,46,0.12);
  color: var(--highlight);
  border-radius: 2px;
  padding: 0 1px;
  font-weight: 700;
}
.gsd-sub {
  font-size: 0.72rem;
  color: var(--text-tertiary);
  font-family: 'Source Sans 3', sans-serif;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-top: 0.1rem;
}
.gsd-badge {
  font-family: 'Montserrat', sans-serif;
  font-size: 0.58rem;
  font-weight: 700;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  padding: 0.15rem 0.45rem;
  border-radius: 4px;
  flex-shrink: 0;
  margin-top: 0.15rem;
}
.gsd-badge.person { background: rgba(26,26,26,0.08); color: #444; }
.gsd-badge.document { background: rgba(26,92,138,0.1); color: #1A5C8A; }
.gsd-badge.event { background: rgba(26,107,60,0.1); color: #1A6B3C; }
.gsd-badge.flight { background: rgba(138,90,26,0.1); color: #8A5A1A; }
.gsd-empty {
  padding: 1.5rem 1rem;
  text-align: center;
  font-family: 'Montserrat', sans-serif;
  font-size: 0.72rem;
  letter-spacing: 0.08em;
  color: var(--text-tertiary);
  text-transform: uppercase;
}
.gsd-loading {
  padding: 1rem;
  text-align: center;
  font-family: 'Montserrat', sans-serif;
  font-size: 0.68rem;
  letter-spacing: 0.12em;
  color: var(--text-tertiary);
  text-transform: uppercase;
  animation: pulse 1.2s ease-in-out infinite;
}
@keyframes pulse { 0%,100%{opacity:0.4} 50%{opacity:1} }
@keyframes highlightFlash {
  0% { background: rgba(200,16,46,0.18); }
  100% { background: transparent; }
}
.highlight-flash { animation: highlightFlash 1.8s ease-out forwards; }
.gsd-footer {
  border-top: 1px solid var(--border);
  padding: 0.5rem 1rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.gsd-footer-hint {
  font-family: 'Montserrat', sans-serif;
  font-size: 0.6rem;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: var(--text-tertiary);
}
kbd {
  display: inline-block;
  background: var(--bg-secondary);
  border: 1px solid var(--border-strong);
  border-radius: 3px;
  padding: 0 4px;
  font-size: 0.6rem;
  font-family: monospace;
  color: var(--text-tertiary);
}

.topbar-right {
  margin-left: auto;
  display: flex;
  align-items: center;
  gap: 0.75rem;
  flex-shrink: 0;
}
.status-dot {
  width: 7px; height: 7px;
  border-radius: 50%;
  background: #1A6B3C;
  box-shadow: 0 0 6px rgba(26,107,60,0.6);
  flex-shrink: 0;
}
.status-text {
  font-family: 'Montserrat', sans-serif;
  font-weight: 500;
  font-size: 0.72rem;
  color: var(--text-secondary);
  white-space: nowrap;
}

/* ── SIDEBAR — LOCKED TYPOGRAPHY, NEVER CHANGES ── */
.sidebar-section { margin-bottom: 1.6rem; }

/* QUERY TYPE / CATEGORY / RELATIONSHIP headers */
.sidebar-label {
  font-family: 'Montserrat', sans-serif !important;
  font-weight: 400 !important;
  font-size: 0.68rem !important;
  color: var(--text-tertiary) !important;
  letter-spacing: 0.12em !important;
  text-transform: uppercase !important;
  margin-bottom: 0.6rem;
  padding: 0 0.25rem;
}

/* Individual nav items — SemiBold */
.nav-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.45rem 0.5rem;
  border-radius: 6px;
  cursor: pointer;
  color: var(--text-secondary);
  font-family: 'Montserrat', sans-serif !important;
  font-weight: 600 !important;
  font-size: 0.82rem !important;
  letter-spacing: 0.01em !important;
  margin-bottom: 0.15rem;
}
.nav-item:hover { background: var(--accent-dim); color: var(--text-primary); }
.nav-item.active {
  background: rgba(26,26,26,0.09);
  color: var(--text-primary);
  font-family: 'Montserrat', sans-serif !important;
  font-weight: 600 !important;
  font-size: 0.82rem !important;
  border-left: 2px solid var(--accent);
  padding-left: calc(0.5rem - 2px);
}

.nav-item.coming-soon { opacity: 0.38; cursor: default; }

.coming-soon-badge {
  font-family: 'Montserrat', sans-serif;
  font-size: 0.55rem;
  color: var(--text-tertiary);
  letter-spacing: 0.06em;
  border: 1px solid var(--border);
  border-radius: 3px;
  padding: 0.05rem 0.3rem;
}

/* ── PROFILES TAB CONTENT ── */
#tabProfiles { padding: 1.5rem 1.75rem; }
.subject-name { font-size: 2.2rem; font-weight: 700; letter-spacing: -0.02em; line-height: 1.1; margin-bottom: 0.6rem; }
.subject-meta { display: flex; gap: 0.4rem; flex-wrap: wrap; align-items: center; }
.meta-pill {
  font-family: 'Montserrat', sans-serif;
  font-size: 0.68rem;
  padding: 0.3rem 0.7rem;
  border-radius: 20px;
  background: var(--surface);
  border: 1px solid var(--border);
  color: var(--text-secondary);
  letter-spacing: 0.04em;
  text-transform: uppercase;
}
.meta-pill.accent { background: var(--accent); color: var(--accent-btn-text); border-color: var(--accent); }

.stats-row { display: grid; grid-template-columns: repeat(4,1fr); gap: 0.75rem; margin: 1.25rem 0; }
.stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 1rem; }
.stat-value { font-size: 1.5rem; font-weight: 700; letter-spacing: -0.02em; }
.stat-label { font-family: 'Montserrat', sans-serif; font-size: 0.6rem; color: var(--text-tertiary); letter-spacing: 0.08em; text-transform: uppercase; margin-top: 0.25rem; }

.section-title { font-family: 'Montserrat', sans-serif; font-size: 0.68rem; color: var(--text-tertiary); letter-spacing: 0.12em; text-transform: uppercase; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border); }

.profile-summary { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 1.1rem 1.25rem; margin-bottom: 1.5rem; font-family: 'Roboto', sans-serif; font-size: 1rem; color: var(--text-secondary); line-height: 1.65; }

.email-volume { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 1rem 1.25rem; margin-bottom: 1.5rem; }
.email-volume-label { font-family: 'Montserrat', sans-serif; font-size: 0.62rem; color: var(--text-tertiary); letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 0.6rem; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 0.25rem; }
.email-volume-bar { height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; }
.email-volume-fill { height: 100%; background: var(--accent); border-radius: 3px; transition: width 0.6s ease; }
.email-volume-count { font-size: 1.4rem; font-weight: 700; letter-spacing: -0.02em; margin-top: 0.5rem; }
.email-volume-sub { font-family: 'Montserrat', sans-serif; font-size: 0.62rem; color: var(--text-tertiary); }

.conf-badge { font-family: 'Montserrat', sans-serif; font-size: 0.65rem; padding: 0.25rem 0.65rem; border-radius: 20px; letter-spacing: 0.06em; white-space: nowrap; }
.conf-badge.confirmed { background: var(--confirmed-bg); color: var(--confirmed); border: 1px solid var(--confirmed-border); }
.conf-badge.corroborated { background: var(--corroborated-bg); color: var(--corroborated); border: 1px solid var(--corroborated-border); }
.conf-badge.indicated { background: var(--indicated-bg); color: var(--indicated); border: 1px solid var(--indicated-border); }
.conf-badge.unverified { background: var(--unverified-bg); color: var(--unverified); border: 1px solid var(--unverified-border); }

.results-grid { display: flex; flex-direction: column; gap: 0.6rem; }
.result-card-profile { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 1rem 1.25rem; cursor: pointer; transition: border-color 0.15s, box-shadow 0.15s; display: flex; justify-content: space-between; align-items: center; gap: 1rem; }
.result-card-profile:hover { border-color: var(--border-strong); box-shadow: var(--shadow-sm); }
.result-name { font-size: 1rem; font-weight: 600; margin-bottom: 0.2rem; }
.result-meta { font-family: 'Montserrat', sans-serif; font-size: 0.68rem; color: var(--text-tertiary); }
.result-docs { font-family: 'Montserrat', sans-serif; font-size: 0.7rem; color: var(--text-secondary); text-align: right; white-space: nowrap; }

/* LANDING */
.landing {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 60vh;
  text-align: center;
  gap: 1rem;
  padding: 2rem 1rem;
}
.landing-title {
  font-family: 'Source Sans 3', 'Source Sans Pro', sans-serif;
  font-weight: 900;
  font-size: 2.8rem;
  color: var(--text-primary);
  max-width: 600px;
  line-height: 1.3;
}
/* Hide right sidebar on landing state */
.landing-active .sidebar-right {
  display: none;
}
.landing-active .main {
  grid-column: 2 / 4;
}
.landing-sub {
  font-family: 'Montserrat', sans-serif;
  font-weight: 500;
  font-size: 0.95rem;
  color: var(--text-tertiary);
  max-width: 600px;
  line-height: 1.75;
}
.landing-suggestions { display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; margin-top: 0.5rem; }
.suggestion-chip {
  font-family: 'Montserrat', sans-serif;
  font-weight: 700;
  font-size: 0.95rem;
  padding: 0.4rem 0.95rem;
  border: 1px solid var(--border);
  border-radius: 20px;
  color: var(--text-secondary);
  cursor: pointer;
  background: var(--surface);
  transition: border-color 0.15s, color 0.15s;
}
.suggestion-chip:hover { border-color: var(--accent); color: var(--text-primary); }

/* STATE MESSAGES */
.state-msg { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 300px; gap: 0.75rem; }
.state-label { font-family: 'Montserrat', sans-serif; font-size: 0.72rem; color: var(--text-tertiary); letter-spacing: 0.12em; }
.state-sub { font-size: 0.85rem; color: var(--text-secondary); max-width: 340px; text-align: center; }

/* ── RIGHT PANEL ── */
.panel-card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 1rem; margin-bottom: 0.75rem; }
.panel-card-title { font-family: 'Montserrat', sans-serif !important; font-weight: 700 !important; font-size: 0.6rem; color: var(--text-tertiary); letter-spacing: 0.12em; text-transform: uppercase; margin-bottom: 0.75rem; }
.power-row { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
.power-row:last-child { margin-bottom: 0; }
.power-label { font-family: 'Montserrat', sans-serif !important; font-weight: 600 !important; font-size: 0.62rem; color: var(--text-secondary); width: 90px; flex-shrink: 0; line-height: 1.3; }
.power-track { flex: 1; height: 3px; background: var(--border); border-radius: 2px; overflow: hidden; }
.power-fill { height: 100%; background: var(--accent); border-radius: 2px; transition: width 0.6s ease; }
.power-val { font-family: 'Montserrat', sans-serif !important; font-weight: 600 !important; font-size: 0.68rem; color: var(--text-primary); width: 22px; text-align: right; flex-shrink: 0; }

/* Co-present persons */
.copresent-row { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0; border-bottom: 1px solid var(--border); }
.copresent-row:last-child { border-bottom: none; }
.copresent-avatar { width: 28px; height: 28px; border-radius: 50%; background: rgba(0,0,0,0.07); display: flex; align-items: center; justify-content: center; font-family: 'Montserrat', sans-serif !important; font-weight: 700 !important; font-size: 0.58rem; color: var(--text-secondary); flex-shrink: 0; }
.copresent-info { flex: 1; min-width: 0; }
.copresent-name { font-family: 'Montserrat', sans-serif !important; font-weight: 600 !important; font-size: 0.8rem; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; }
.copresent-name:hover { text-decoration: underline; }
.copresent-meta { font-family: 'Montserrat', sans-serif !important; font-weight: 600 !important; font-size: 0.58rem; color: var(--text-tertiary); margin-top: 1px; }
.copresent-right { display: flex; flex-direction: column; align-items: flex-end; gap: 3px; flex-shrink: 0; }
.copresent-bar-wrap { width: 50px; height: 2px; background: var(--border); border-radius: 1px; overflow: hidden; }
.copresent-bar-fill { height: 100%; background: var(--accent); border-radius: 1px; }
.copresent-count { font-family: 'Montserrat', sans-serif !important; font-weight: 600 !important; font-size: 0.6rem; color: var(--text-tertiary); white-space: nowrap; }

/* Locations */
.location-row { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0; border-bottom: 1px solid var(--border); }
.location-row:last-child { border-bottom: none; }
.location-icon { width: 26px; height: 26px; border-radius: 6px; background: var(--surface); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 0.8rem; flex-shrink: 0; }
.location-info { flex: 1; min-width: 0; }
.location-name { font-family: 'Montserrat', sans-serif !important; font-weight: 600 !important; font-size: 0.8rem; color: var(--text-primary); }
.location-meta { font-family: 'Montserrat', sans-serif !important; font-weight: 600 !important; font-size: 0.58rem; color: var(--text-tertiary); margin-top: 1px; }
.location-count { font-family: 'Montserrat', sans-serif !important; font-weight: 600 !important; font-size: 0.68rem; color: var(--text-primary); white-space: nowrap; flex-shrink: 0; }

/* Source docs */
.source-doc-row { display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; padding: 0.5rem 0; border-bottom: 1px solid var(--border); }
.source-doc-row:last-child { border-bottom: none; }
.source-doc-id { font-family: 'Roboto', sans-serif !important; font-weight: 600 !important; font-size: 0.72rem; color: var(--text-primary); }
.source-doc-meta { font-family: 'Roboto', sans-serif !important; font-weight: 400 !important; font-size: 0.58rem; color: var(--text-tertiary); margin-top: 2px; }
.conf-circle { width: 20px; height: 20px; border-radius: 50%; border: 1px solid; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-family: 'Montserrat', sans-serif !important; font-weight: 600 !important; font-size: 0.6rem; }
.conf-circle.confirmed { border-color: var(--confirmed); color: var(--confirmed); }
.conf-circle.corroborated { border-color: var(--corroborated); color: var(--corroborated); }
.conf-circle.none { border-color: var(--border-mid); color: var(--text-tertiary); }

/* Timeline events */
.timeline-wrap { position: relative; padding-left: 1rem; }
.timeline-item { display: flex; gap: 1rem; margin-bottom: 1.25rem; position: relative; }
.timeline-date { font-family: 'Montserrat', sans-serif; font-size: 0.62rem; color: var(--text-tertiary); min-width: 64px; text-align: right; padding-top: 0.85rem; flex-shrink: 0; }
.timeline-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--text-tertiary); flex-shrink: 0; margin-top: 1rem; position: relative; z-index: 1; }
.timeline-dot.confirmed { background: var(--confirmed); }
.timeline-dot.corroborated { background: var(--corroborated); }
.timeline-dot.indicated { background: var(--indicated); }
.timeline-dot.unverified { background: var(--unverified); }
.timeline-card { flex: 1; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 0.85rem 1rem; }
.timeline-card-header { display: flex; align-items: flex-start; justify-content: space-between; gap: 0.5rem; margin-bottom: 0.5rem; }
.timeline-card-title { font-family: 'Roboto', sans-serif; font-size: 0.88rem; font-weight: 600; color: var(--text-primary); }
.timeline-card-body { font-family: 'Roboto', sans-serif; font-size: 0.8rem; color: var(--text-secondary); line-height: 1.6; margin-bottom: 0.6rem; }
.timeline-tags { display: flex; flex-wrap: wrap; gap: 0.35rem; }
.timeline-tag { font-family: 'Montserrat', sans-serif; font-size: 0.6rem; color: var(--text-secondary); background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 4px; padding: 2px 7px; letter-spacing: 0.02em; }
.timeline-tag.island { color: #dc2626; border-color: rgba(220,38,38,0.3); background: rgba(220,38,38,0.06); }

/* Evidence gap banner */
.evidence-gap { margin-top: 1rem; padding: 0.85rem 1rem; background: rgba(220,38,38,0.06); border: 1px solid rgba(220,38,38,0.2); border-radius: 10px; }
.evidence-gap-label { font-family: 'Montserrat', sans-serif; font-size: 0.58rem; font-weight: 700; color: #dc2626; letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 0.4rem; }
.evidence-gap-text { font-family: 'Roboto', sans-serif; font-size: 0.8rem; color: var(--text-secondary); line-height: 1.5; }

/* ── TAB PANELS ── */
.tab-panel { display: none; width: 100%; }
.tab-panel.active { display: block; }

/* ── UNIDENTIFIED TAB ── */
#tabUnidentified {
  font-family: 'Source Sans 3', sans-serif;
}
/* Page header */
#tabUnidentified .page-header {
  background: var(--bg);
  color: var(--text-primary);
  padding: 3rem 2rem 2.5rem;
  position: relative;
  overflow: hidden;
  border-bottom: 1px solid var(--border);
}
#tabUnidentified .page-header::before {
  display: none;
}
#tabUnidentified .header-inner {
  max-width: 760px;
  margin: 0 auto;
  position: relative;
}
#tabUnidentified .header-classification {
  font-family: 'Montserrat', sans-serif;
  font-size: 0.68rem;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  color: var(--text-tertiary);
  margin-bottom: 1.2rem;
  display: flex;
  align-items: center;
  gap: 1rem;
}
#tabUnidentified .header-classification::before,
#tabUnidentified .header-classification::after {
  content: '';
  flex: 1;
  height: 1px;
  background: var(--border);
}
#tabUnidentified .header-title {
  font-family: 'neue-haas-grotesk-display', sans-serif;
  font-weight: 500;
  font-size: clamp(1.6rem, 4vw, 2.6rem);
  line-height: 1.05;
  letter-spacing: -0.02em;
  margin-bottom: 1rem;
  color: var(--text-primary);
}
#tabUnidentified .header-title em { font-style: normal; color: var(--text-tertiary); }
#tabUnidentified .header-desc {
  font-size: 0.95rem;
  line-height: 1.65;
  color: var(--text-secondary);
  max-width: 520px;
  margin-bottom: 1.75rem;
}
#tabUnidentified .header-stats { display: flex; gap: 2rem; flex-wrap: wrap; }
#tabUnidentified .stat-item { display: flex; flex-direction: column; gap: 0.2rem; }
#tabUnidentified .stat-num {
  font-family: 'neue-haas-grotesk-display', sans-serif;
  font-size: 1.75rem; font-weight: 600;
  color: var(--text-primary); line-height: 1;
}
#tabUnidentified .stat-label {
  font-family: 'Montserrat', sans-serif;
  font-size: 0.62rem; letter-spacing: 0.12em; text-transform: uppercase;
  color: var(--text-tertiary);
}
#tabUnidentified .stat-divider { width: 1px; background: var(--border); align-self: stretch; }

#tabUnidentified .methodology {
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border-mid);
  padding: 1rem 2rem;
}
#tabUnidentified .methodology-inner {
  max-width: 760px; margin: 0 auto;
  display: flex; align-items: flex-start; gap: 1rem;
}
#tabUnidentified .method-icon { font-size: 0.8rem; color: var(--text-tertiary); margin-top: 0.15rem; flex-shrink: 0; }
#tabUnidentified .method-text { font-size: 0.82rem; line-height: 1.6; color: var(--text-secondary); }
#tabUnidentified .method-text strong { color: var(--text-primary); font-weight: 600; }

#tabUnidentified .u-main { max-width: 760px; margin: 0 auto; padding: 2.5rem 2rem 4rem; }

#tabUnidentified .section-label {
  font-family: 'Montserrat', sans-serif;
  font-size: 0.65rem; letter-spacing: 0.18em; text-transform: uppercase;
  color: var(--text-tertiary); margin-bottom: 1.5rem;
  display: flex; align-items: center; gap: 0.75rem;
}
#tabUnidentified .section-label::after { content: ''; flex: 1; height: 1px; background: var(--border-mid); }

#tabUnidentified .featured-flight {
  position: relative;
  background: var(--bg-card);
  border: 1px solid var(--border-mid);
  border-radius: 4px;
  padding: 2rem;
  margin-bottom: 1.25rem;
  overflow: hidden;
}
#tabUnidentified .featured-flight::before {
  content: '';
  position: absolute; left: 0; top: 0; bottom: 0; width: 3px;
  background: var(--text-primary);
}
#tabUnidentified .featured-stamp {
  position: absolute; top: 1.25rem; right: 1.5rem;
  font-family: 'Montserrat', sans-serif;
  font-size: 0.6rem; letter-spacing: 0.2em; text-transform: uppercase;
  color: var(--stamp-border);
  border: 1.5px solid var(--stamp-border);
  padding: 0.25rem 0.6rem; border-radius: 2px;
  background: var(--stamp-color);
  transform: rotate(1.5deg); white-space: nowrap;
}
#tabUnidentified .flight-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 1.5rem 1.75rem;
  margin-bottom: 0.75rem;
  transition: border-color 0.2s;
}
#tabUnidentified .flight-card:hover { border-color: var(--border-strong); }
#tabUnidentified .flight-meta {
  display: flex; align-items: center; gap: 1rem;
  margin-bottom: 1rem; flex-wrap: wrap;
}
#tabUnidentified .flight-date {
  font-family: 'Montserrat', sans-serif; font-size: 0.72rem;
  color: var(--text-tertiary); letter-spacing: 0.05em;
}
#tabUnidentified .flight-route {
  display: flex; align-items: center; gap: 0.5rem;
  font-family: 'Montserrat', sans-serif; font-size: 0.8rem;
  color: var(--text-primary); font-weight: 500;
}
#tabUnidentified .route-arrow { color: var(--text-tertiary); font-size: 0.7rem; }
#tabUnidentified .flight-route-name { font-size: 0.78rem; color: var(--text-secondary); }
#tabUnidentified .unknown-count-pill {
  margin-left: auto;
  font-family: 'Montserrat', sans-serif; font-size: 0.62rem;
  letter-spacing: 0.08em; text-transform: uppercase;
  color: var(--text-primary);
  border: 1px solid var(--border-strong);
  padding: 0.18rem 0.5rem; border-radius: 2px; white-space: nowrap;
  background: var(--bg-secondary);
}
#tabUnidentified .manifest-label {
  font-family: 'Montserrat', sans-serif; font-size: 0.6rem;
  letter-spacing: 0.15em; text-transform: uppercase;
  color: var(--text-tertiary); margin-bottom: 0.65rem;
}
#tabUnidentified .passenger-list { display: flex; flex-direction: column; gap: 0.3rem; }
#tabUnidentified .passenger-row { display: flex; align-items: center; gap: 0.75rem; font-size: 0.88rem; }
#tabUnidentified .passenger-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--border-strong); flex-shrink: 0; }
#tabUnidentified .passenger-name { color: var(--text-primary); }
#tabUnidentified .passenger-name a { color: inherit; text-decoration: none; border-bottom: 1px solid var(--border-mid); transition: border-color 0.15s; }
#tabUnidentified .passenger-name a:hover { border-bottom-color: var(--text-primary); }
#tabUnidentified .passenger-role { font-size: 0.72rem; color: var(--text-tertiary); font-family: 'Montserrat', sans-serif; }
#tabUnidentified .passenger-row.redacted .passenger-dot { background: var(--redact-color); }
#tabUnidentified .redacted-bar { display: inline-flex; align-items: center; gap: 0.5rem; }
#tabUnidentified .redacted-label {
  display: inline-block; background: var(--redact-color); color: var(--bg);
  font-family: 'Montserrat', sans-serif; font-size: 0.7rem; letter-spacing: 0.06em;
  padding: 0.16rem 0.6rem; border-radius: 2px; opacity: 0.85; user-select: none;
}
#tabUnidentified .redacted-count { font-family: 'Montserrat', sans-serif; font-size: 0.65rem; color: var(--text-tertiary); }
#tabUnidentified .flight-card:hover .redacted-label,
#tabUnidentified .featured-flight:hover .redacted-label { animation: shimmer 1.8s ease infinite; }
@keyframes shimmer { 0%,100%{opacity:.85} 50%{opacity:.5} }
#tabUnidentified .manifest-divider { height: 1px; background: var(--border); margin: 0.75rem 0; }
#tabUnidentified .context-note {
  font-size: 0.82rem; line-height: 1.6; color: var(--text-secondary);
  font-style: italic; padding-top: 0.75rem;
  border-top: 1px solid var(--border); margin-top: 1rem;
}
#tabUnidentified .summary-section { margin-top: 3rem; }
#tabUnidentified .summary-grid {
  display: grid; grid-template-columns: 1fr 1fr;
  gap: 1px; background: var(--border-mid);
  border: 1px solid var(--border-mid); border-radius: 4px;
  overflow: hidden; margin-top: 1.25rem;
}
#tabUnidentified .summary-cell { background: var(--bg-card); padding: 1.1rem 1.25rem; }
#tabUnidentified .summary-cell-label {
  font-family: 'Montserrat', sans-serif; font-size: 0.6rem;
  letter-spacing: 0.14em; text-transform: uppercase;
  color: var(--text-tertiary); margin-bottom: 0.4rem;
}
#tabUnidentified .summary-cell-value { font-size: 0.88rem; color: var(--text-primary); line-height: 1.5; }
#tabUnidentified .pattern-block {
  margin-top: 3rem; padding: 1.75rem;
  background: var(--bg-secondary);
  border: 1px solid var(--border-mid); border-radius: 4px;
}
#tabUnidentified .pattern-title {
  font-family: 'neue-haas-grotesk-display', sans-serif;
  font-size: 1rem; font-weight: 600; margin-bottom: 0.9rem;
}
#tabUnidentified .pattern-list { display: flex; flex-direction: column; gap: 0.6rem; }
#tabUnidentified .pattern-item { display: flex; gap: 1rem; font-size: 0.88rem; line-height: 1.55; color: var(--text-secondary); }
#tabUnidentified .pattern-num { font-family: 'Montserrat', sans-serif; font-size: 0.68rem; color: var(--text-tertiary); flex-shrink: 0; padding-top: 0.15rem; min-width: 1.5rem; }
#tabUnidentified .pattern-item strong { color: var(--text-primary); font-weight: 600; }
#tabUnidentified .loading-state { text-align: center; padding: 4rem 2rem; color: var(--text-tertiary); font-family: 'Montserrat', sans-serif; font-size: 0.75rem; letter-spacing: 0.1em; }

/* ── CONNECTIONS TAB ── */
#tabConnections {
  font-family: 'Source Sans 3', sans-serif;
}
#tabConnections .page-wrap {
  max-width: 760px; margin: 0 auto; padding: 2.5rem 2rem 4rem;
}
#tabConnections .page-title {
  font-family: 'neue-haas-grotesk-display', sans-serif;
  font-weight: 500; font-size: clamp(1.6rem, 3.5vw, 2.4rem);
  letter-spacing: -0.02em; line-height: 1.1; margin-bottom: 0.65rem;
}
#tabConnections .page-subtitle {
  font-size: 0.95rem; line-height: 1.6;
  color: var(--text-secondary); max-width: 520px; margin-bottom: 2rem;
}
#tabConnections .search-panel {
  display: grid; grid-template-columns: 1fr auto 1fr;
  align-items: end; gap: 1rem;
  background: var(--bg-card);
  border: 1px solid var(--border-mid);
  border-radius: 6px; padding: 1.25rem; margin-bottom: 1rem;
}
#tabConnections .search-field { display: flex; flex-direction: column; gap: 0.4rem; }
#tabConnections .search-label {
  font-family: 'Montserrat', sans-serif; font-size: 0.62rem;
  letter-spacing: 0.14em; text-transform: uppercase; color: var(--text-tertiary);
}
#tabConnections .search-input-wrap { position: relative; }
#tabConnections .search-input {
  width: 100%; font-family: 'Montserrat', sans-serif; font-weight: 500;
  font-size: 0.9rem; color: var(--text-primary);
  background: var(--bg); border: 1px solid var(--border-mid);
  border-radius: 4px; padding: 0.55rem 0.75rem; outline: none; transition: border-color 0.15s;
}
#tabConnections .search-input:focus { border-color: var(--border-strong); }
#tabConnections .search-input::placeholder { color: var(--text-tertiary); font-family: 'Source Sans 3', sans-serif; font-style: italic; font-weight: 300; }
#tabConnections .autocomplete-list {
  position: absolute; top: calc(100% + 4px); left: 0; right: 0;
  background: var(--bg-card); border: 1px solid var(--border-mid);
  border-radius: 4px; z-index: 50;
  max-height: 220px; overflow-y: auto;
  box-shadow: 0 4px 16px rgba(0,0,0,0.08);
  display: none;
}
#tabConnections .autocomplete-list.open { display: block; }
#tabConnections .autocomplete-item {
  padding: 0.5rem 0.75rem; font-size: 0.88rem; cursor: pointer;
  display: flex; flex-direction: column; gap: 0.15rem;
  border-bottom: 1px solid var(--border); transition: background 0.1s;
}
#tabConnections .autocomplete-item:last-child { border-bottom: none; }
#tabConnections .autocomplete-item:hover,
#tabConnections .autocomplete-item.active-item { background: var(--accent-bg); }
#tabConnections .autocomplete-name { color: var(--text-primary); font-family: 'Montserrat', sans-serif; font-weight: 500; }
#tabConnections .autocomplete-meta { font-family: 'Montserrat', sans-serif; font-size: 0.62rem; letter-spacing: 0.04em; color: var(--text-tertiary); text-transform: uppercase; }
#tabConnections .connector-label {
  font-family: 'neue-haas-grotesk-display', sans-serif;
  font-size: 1.4rem; color: var(--text-tertiary);
  text-align: center; padding-bottom: 0.5rem; align-self: end;
}
#tabConnections .search-btn {
  width: 100%; font-family: 'Montserrat', sans-serif;
  font-size: 0.72rem; letter-spacing: 0.1em; text-transform: uppercase;
  background: var(--text-primary); color: var(--bg);
  border: none; border-radius: 4px; padding: 0.6rem 1.25rem;
  cursor: pointer; transition: opacity 0.15s;
}
#tabConnections .search-btn:hover { opacity: 0.8; }
#tabConnections .search-btn:disabled { opacity: 0.3; cursor: default; }
#tabConnections .quick-label {
  font-family: 'Montserrat', sans-serif; font-size: 0.62rem;
  letter-spacing: 0.12em; text-transform: uppercase;
  color: var(--text-tertiary); margin-bottom: 0.5rem;
}
#tabConnections .quick-pairs { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 2rem; }
#tabConnections .quick-pair {
  font-family: 'Montserrat', sans-serif; font-size: 0.7rem; letter-spacing: 0.03em;
  border: 1px solid var(--border-mid); border-radius: 3px; padding: 0.28rem 0.65rem;
  cursor: pointer; color: var(--text-secondary); background: var(--bg-card);
  transition: all 0.15s; white-space: nowrap;
}
#tabConnections .quick-pair:hover { background: var(--accent-bg); border-color: var(--border-strong); color: var(--text-primary); }
#tabConnections .no-path { padding: 2rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; text-align: center; }
#tabConnections .no-path-title { font-family: 'neue-haas-grotesk-display', sans-serif; font-size: 1.1rem; margin-bottom: 0.5rem; }
#tabConnections .no-path-sub { font-size: 0.88rem; color: var(--text-secondary); }
#tabConnections .result-card {
  background: var(--bg-card); border: 1px solid var(--border-mid);
  border-radius: 6px; overflow: hidden; animation: fadeUp 0.3s ease;
}
@keyframes fadeUp { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
#tabConnections .result-header {
  padding: 1.1rem 1.25rem; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between; gap: 1rem; flex-wrap: wrap;
}
#tabConnections .result-headline { font-family: 'neue-haas-grotesk-display', sans-serif; font-size: 1rem; font-weight: 500; letter-spacing: -0.01em; }
#tabConnections .degree-badge { font-family: 'Montserrat', sans-serif; font-size: 0.65rem; letter-spacing: 0.1em; text-transform: uppercase; padding: 0.25rem 0.65rem; border-radius: 2px; white-space: nowrap; }
#tabConnections .degree-badge.deg-1 { background: var(--highlight-dim); color: var(--highlight); border: 1px solid var(--highlight-mid); }
#tabConnections .degree-badge.deg-2 { background: rgba(26,26,26,0.05); color: var(--text-secondary); border: 1px solid var(--border-mid); }
#tabConnections .degree-badge.deg-3 { background: var(--bg-secondary); color: var(--text-tertiary); border: 1px solid var(--border); }
#tabConnections .path-viz { padding: 1.75rem 1.25rem; display: flex; flex-direction: column; }
#tabConnections .path-node { display: flex; align-items: flex-start; gap: 1rem; }
#tabConnections .node-indicator { display: flex; flex-direction: column; align-items: center; flex-shrink: 0; width: 36px; }
#tabConnections .node-dot { width: 36px; height: 36px; border-radius: 50%; background: var(--node-bg); color: var(--node-text); display: flex; align-items: center; justify-content: center; font-family: 'Montserrat', sans-serif; font-size: 0.65rem; letter-spacing: 0.05em; flex-shrink: 0; position: relative; z-index: 1; }
#tabConnections .node-dot.endpoint { background: var(--text-primary); box-shadow: 0 0 0 3px var(--bg), 0 0 0 4px var(--text-primary); }
#tabConnections .node-line { width: 1px; background: var(--border-mid); flex: 1; min-height: 0; }
#tabConnections .node-content { padding-top: 0.4rem; padding-bottom: 1.25rem; flex: 1; }
#tabConnections .node-name { font-family: 'neue-haas-grotesk-display', sans-serif; font-size: 1rem; font-weight: 500; letter-spacing: -0.01em; margin-bottom: 0.2rem; }
#tabConnections .node-name a { color: inherit; text-decoration: none; border-bottom: 1px solid transparent; transition: border-color 0.15s; }
#tabConnections .node-name a:hover { border-bottom-color: var(--text-primary); }
#tabConnections .node-meta { font-family: 'Montserrat', sans-serif; font-size: 0.65rem; letter-spacing: 0.07em; text-transform: uppercase; color: var(--text-tertiary); }
#tabConnections .path-edge { display: flex; align-items: flex-start; gap: 1rem; }
#tabConnections .edge-indicator { width: 36px; display: flex; flex-direction: column; align-items: center; flex-shrink: 0; }
#tabConnections .edge-line-top, #tabConnections .edge-line-bot { width: 1px; background: var(--border-mid); flex: 1; min-height: 10px; }
#tabConnections .edge-icon { font-size: 0.55rem; color: var(--text-tertiary); flex-shrink: 0; padding: 2px 0; }
#tabConnections .edge-content { padding: 0.5rem 0; flex: 1; }
#tabConnections .edge-label { display: inline-flex; align-items: center; gap: 0.5rem; font-family: 'Montserrat', sans-serif; font-size: 0.68rem; letter-spacing: 0.05em; color: var(--text-secondary); background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 3px; padding: 0.28rem 0.6rem; }
#tabConnections .edge-label.flight-edge { background: var(--highlight-dim); border-color: var(--highlight-mid); color: var(--highlight); }
#tabConnections .edge-dot { width: 5px; height: 5px; border-radius: 50%; background: currentColor; flex-shrink: 0; }
#tabConnections .edge-detail { font-size: 0.8rem; color: var(--text-tertiary); margin-top: 0.3rem; line-height: 1.5; }
#tabConnections .alt-paths { border-top: 1px solid var(--border); padding: 1.1rem 1.25rem; }
#tabConnections .alt-title { font-family: 'Montserrat', sans-serif; font-size: 0.62rem; letter-spacing: 0.12em; text-transform: uppercase; color: var(--text-tertiary); margin-bottom: 0.65rem; }
#tabConnections .alt-list { display: flex; flex-direction: column; gap: 0.35rem; }
#tabConnections .alt-item { font-size: 0.85rem; color: var(--text-secondary); display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.3rem 0.5rem; border-radius: 3px; transition: background 0.1s; }
#tabConnections .alt-item:hover { background: var(--accent-bg); color: var(--text-primary); }
#tabConnections .alt-arrow { color: var(--text-tertiary); font-size: 0.7rem; }
.cat-finance     { color: #2E6F40; }
.cat-politics    { color: #CC2222; }
.cat-technology  { color: #000080; }
.cat-legal       { color: #9A8000; }
.cat-academia    { color: #6B4226; }
.cat-entertainment { color: #CC4400; }
.cat-royalty     { color: #C8909A; }
.cat-media       { color: #008B87; }
.cat-other       { color: #888888; }


/* ── MOBILE HAMBURGER ── */
.mobile-menu-btn {
  display: none;
  background: none;
  border: 1px solid var(--border);
  border-radius: 7px;
  padding: 0.35rem 0.55rem;
  cursor: pointer;
  color: var(--text-secondary);
  font-size: 1.1rem;
  line-height: 1;
  flex-shrink: 0;
}

/* ── MOBILE DRAWER ── */
.mobile-drawer {
  display: none;
  position: fixed;
  inset: 0;
  z-index: 200;
}
.mobile-drawer.open { display: block; }
.drawer-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.45); }
.drawer-panel {
  position: absolute;
  top: 0; left: 0; bottom: 0;
  width: 280px;
  background: var(--bg-secondary);
  padding: 1.25rem 1rem;
  overflow-y: auto;
  box-shadow: 4px 0 24px rgba(0,0,0,0.18);
}
.drawer-close { display: flex; justify-content: flex-end; margin-bottom: 1rem; }
.drawer-close button {
  background: none; border: 1px solid var(--border);
  border-radius: 6px; padding: 0.3rem 0.65rem;
  cursor: pointer; color: var(--text-secondary); font-size: 0.8rem;
}


/* ── FLIGHT MANIFEST BROWSER ── */
.fm-list { display: flex; flex-direction: column; }
.fm-row {
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  transition: background 0.12s;
}
.fm-row:hover, .fm-row.fm-row-open { background: var(--accent-dim); }
.fm-row-main {
  display: flex; align-items: center; gap: 0.75rem;
  padding: 0.7rem 0.5rem;
  flex-wrap: wrap;
}
.fm-date {
  font-family: 'Montserrat', sans-serif; font-size: 0.82rem;
  color: var(--text-tertiary); min-width: 88px; flex-shrink: 0;
  letter-spacing: 0.02em;
}
.fm-route {
  display: flex; align-items: center; gap: 0.3rem;
  font-family: 'Montserrat', sans-serif; font-weight: 600;
  font-size: 0.82rem; color: var(--text-primary); flex-shrink: 0;
}
.fm-airport { letter-spacing: 0.04em; }
.fm-arrow-route { color: var(--text-tertiary); font-size: 0.7rem; }
.fm-city-names { font-size: 0.78rem; color: var(--text-secondary); flex: 1; min-width: 0; }
.fm-badges { display: flex; gap: 0.35rem; align-items: center; flex-shrink: 0; }
.fm-badge-island {
  font-family: 'Montserrat', sans-serif; font-size: 0.55rem;
  color: #dc2626; letter-spacing: 0.06em;
  padding: 1px 5px; border: 1px solid #dc2626; border-radius: 3px;
}
.fm-pax-count {
  font-family: 'Montserrat', sans-serif; font-size: 0.65rem;
  color: var(--text-tertiary); flex-shrink: 0; min-width: 40px; text-align: right;
}
.fm-chevron {
  font-size: 1.1rem; color: var(--text-tertiary); flex-shrink: 0;
  transition: transform 0.2s; line-height: 1; width: 16px; text-align: center;
}

/* Expanded manifest panel */
.fm-manifest { border-top: 1px dashed var(--border); }
.fm-manifest-inner { padding: 1rem 0.5rem 1.25rem 1.5rem; }
.fm-manifest-label {
  font-family: 'Montserrat', sans-serif; font-size: 0.6rem;
  letter-spacing: 0.14em; text-transform: uppercase;
  color: var(--text-tertiary); margin-bottom: 0.75rem;
}
.fm-pax-list { display: flex; flex-direction: column; gap: 0.25rem; margin-bottom: 0.75rem; }
.fm-pax-row {
  display: flex; align-items: center; gap: 0.65rem;
  padding: 0.45rem 0.6rem; border-radius: 6px;
  cursor: pointer; transition: background 0.1s;
}
.fm-pax-row:not(.fm-pax-redacted):hover { background: var(--surface); }
.fm-pax-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
.fm-pax-name {
  font-size: 0.88rem; font-weight: 600; color: var(--text-primary);
  flex: 1;
}
.fm-pax-meta {
  font-family: 'Montserrat', sans-serif; font-size: 0.62rem;
  color: var(--text-tertiary); letter-spacing: 0.03em;
}
.fm-pax-arrow {
  font-size: 0.75rem; color: var(--text-tertiary); flex-shrink: 0;
  opacity: 0; transition: opacity 0.1s;
}
.fm-pax-row:hover .fm-pax-arrow { opacity: 1; }
.fm-manifest-footer {
  font-family: 'Montserrat', sans-serif; font-size: 0.6rem;
  color: var(--text-tertiary); letter-spacing: 0.04em;
  display: flex; flex-direction: column; gap: 0.2rem;
  padding-top: 0.75rem; border-top: 1px solid var(--border);
}
.fm-notes { opacity: 0.7; font-style: italic; }

/* ── RESPONSIVE ── */
@media (max-width: 768px) {
  .app { grid-template-columns: 1fr; grid-template-rows: 56px 1fr; height: 100vh; overflow: hidden; }
  .topbar { grid-column: 1; padding: 0 0.75rem; gap: 0.5rem; overflow: hidden; }
  .sidebar-left { display: none; }
  .sidebar-right { display: none; }
  .main { grid-column: 1; grid-row: 2; padding: 0; }
  .mobile-menu-btn { display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
  .topbar-center { max-width: none; min-width: 0; flex: 1; }
  .logo-main { font-size: 1rem; }
  .logo-the { font-size: 0.46rem; }
  .stats-row { grid-template-columns: 1fr 1fr; }
  .subject-name { font-size: 1.5rem; }
  .status-text { display: none; }
  .status-dot { display: none; }

  .topbar-right { display: none; }
  #tabUnidentified .page-header { padding: 2rem 1.25rem 1.5rem; }
  #tabUnidentified .u-main { padding: 1.5rem 1.25rem 3rem; }
  #tabUnidentified .header-stats { gap: 1.25rem; }
  #tabUnidentified .stat-divider { display: none; }
  #tabUnidentified .summary-grid { grid-template-columns: 1fr; }
  #tabConnections .page-wrap { padding: 1.5rem 1.25rem 3rem; }
  #tabConnections .search-panel { grid-template-columns: 1fr; }
  #tabConnections .connector-label { display: none; }
}
@media (max-width: 420px) {
  .suggestion-chip { font-size: 0.78rem; padding: 0.35rem 0.75rem; }
  .landing-title { font-size: 1.4rem; }
}
</style>
</head>
<body>
<div class="app landing-active">

  <!-- TOPBAR -->
  <header class="topbar">
    <button class="mobile-menu-btn" onclick="openDrawer()" aria-label="Menu">☰</button>
    <div class="topbar-logo" onclick="switchTab('profiles'); document.getElementById('searchInput').value=''; document.getElementById('globalSearchClear').style.display='none'; if(typeof closeGSD==='function')closeGSD(); showLanding();" style="cursor:pointer;">
      <span class="logo-the">The</span>
      <span class="logo-main">Reckoning Radar</span>
    </div>
    <div class="global-search-wrap" id="globalSearchWrap">
      <div class="global-search-input-row" id="globalSearchRow">
        <span class="search-icon">⌕</span>
        <input class="search-bar" id="searchInput" type="text" 
          placeholder="Search persons, documents, events, flights…"
          autocomplete="off" spellcheck="false">
        <span id="globalSearchClear" style="display:none;cursor:pointer;color:var(--text-tertiary);font-size:1.1rem;line-height:1;padding:0 2px;" onclick="clearGlobalSearch()">×</span>
      </div>
      <div class="global-search-dropdown" id="globalSearchDropdown"></div>
    </div>
    <div class="topbar-right">
      <div style="display:flex;align-items:center;gap:0.4rem;">
        <div class="status-dot"></div>
        <span class="status-text">123 profiles indexed</span>
      </div>
    </div>
  </header>

  <!-- LEFT SIDEBAR -->
  <aside class="sidebar-left">
    <div class="sidebar-section">
      <div class="sidebar-label">Query Type</div>
      <div class="nav-item active" id="navProfiles" onclick="switchTab('profiles'); document.getElementById('searchInput').value=''; document.getElementById('globalSearchClear').style.display='none'; if(typeof closeGSD==='function')closeGSD(); showLanding();"><span>Person Profile</span></div>
      <div class="nav-item" id="navFlights" onclick="switchTab('flights')" style="cursor:pointer;"><span>Flight Manifests</span></div>
      <div class="nav-item" onclick="window.location.href='graph.html'" style="cursor:pointer;"><span>Network Graph</span><span class="coming-soon-badge" style="background:rgba(26,107,60,0.12);color:#1A6B3C;border-color:rgba(26,107,60,0.3);">LIVE</span></div>
      <div class="nav-item" id="navUnidentified" onclick="switchTab('unidentified')" style="cursor:pointer;"><span>Unidentified</span><span class="coming-soon-badge" style="background:rgba(180,40,40,0.1);color:#B42828;border-color:rgba(180,40,40,0.3);">NEW</span></div>
      <div class="nav-item" id="navConnections" onclick="switchTab('connections')" style="cursor:pointer;"><span>Connections</span><span class="coming-soon-badge" style="background:rgba(26,26,26,0.08);color:#444;border-color:rgba(26,26,26,0.2);">NEW</span></div>
      <div class="nav-item coming-soon"><span>Location Map</span><span class="coming-soon-badge">SOON</span></div>
    </div>
    <div class="sidebar-section" id="sidebarFilters">
      <div class="sidebar-label">Category</div>
      <div class="nav-item filter-item" data-filter="category" data-value="finance"><span>Finance</span></div>
      <div class="nav-item filter-item" data-filter="category" data-value="politics"><span>Politics</span></div>
      <div class="nav-item filter-item" data-filter="category" data-value="technology"><span>Technology</span></div>
      <div class="nav-item filter-item" data-filter="category" data-value="legal"><span>Legal</span></div>
      <div class="nav-item filter-item" data-filter="category" data-value="academia"><span>Academia</span></div>
      <div class="nav-item filter-item" data-filter="category" data-value="entertainment"><span>Entertainment</span></div>
      <div class="nav-item filter-item" data-filter="category" data-value="royalty"><span>Royalty</span></div>
      <div class="nav-item filter-item" data-filter="category" data-value="media"><span>Media</span></div>
    </div>
    <div class="sidebar-section" id="sidebarRelFilters">
      <div class="sidebar-label">Relationship</div>
      <div class="nav-item filter-item" data-filter="relationship" data-value="direct_contact"><span>Direct Contact</span></div>
      <div class="nav-item filter-item" data-filter="relationship" data-value="employee"><span>Employee / Staff</span></div>
      <div class="nav-item filter-item" data-filter="relationship" data-value="alleged_client"><span>Alleged Client</span></div>
      <div class="nav-item filter-item" data-filter="relationship" data-value="victim"><span>Victim / Survivor</span></div>
      <div class="nav-item filter-item" data-filter="relationship" data-value="legal_counsel"><span>Legal Counsel</span></div>
    </div>
  </aside>

  <!-- MAIN — hosts all tab panels -->
  <main class="main" id="main">

    <!-- ── TAB: PROFILES ── -->
    <div class="tab-panel active" id="tabProfiles">
      <div class="landing">
        <div class="landing-title">Search the<br>Epstein DOJ Database</div>
        <div class="landing-sub">123 individuals indexed from the Epstein archive and pilot logbooks. Search by name, document title, event, or flight route to investigate connections, build timelines, and analyze the network.</div>
        <div class="landing-suggestions">
          <span class="suggestion-chip" onclick="doSearch('Lesley Groff')">Lesley Groff</span>
          <span class="suggestion-chip" onclick="doSearch('Ghislaine Maxwell')">Ghislaine Maxwell</span>
          <span class="suggestion-chip" onclick="doSearch('Jean-Luc Brunel')">Jean-Luc Brunel</span>
          <span class="suggestion-chip" onclick="doSearch('Donald Trump')">Donald Trump</span>
          <span class="suggestion-chip" onclick="doSearch('Prince Andrew, Duke of York')">Prince Andrew</span>
          <span class="suggestion-chip" onclick="doSearch('Bill Gates')">Bill Gates</span>
          <span class="suggestion-chip" onclick="doSearch('Steve Bannon')">Steve Bannon</span>
          <span class="suggestion-chip" onclick="doSearch('Ehud Barak')">Ehud Barak</span>
          <span class="suggestion-chip" onclick="doSearch('Les Wexner')">Les Wexner</span>
          <span class="suggestion-chip" onclick="doSearch('Alan Dershowitz')">Alan Dershowitz</span>
          <span class="suggestion-chip" onclick="doSearch('Richard Branson')">Richard Branson</span>
          <span class="suggestion-chip" onclick="doSearch('Larry Summers')">Larry Summers</span>
          <span class="suggestion-chip" onclick="doSearch('Elon Musk')">Elon Musk</span>
          <span class="suggestion-chip" onclick="doSearch('Sarah Ferguson')">Sarah Ferguson</span>
        </div>
      </div>
    </div>

    <!-- ── TAB: UNIDENTIFIED ── -->
    <div class="tab-panel" id="tabUnidentified">
      <!-- Dark header band -->
      <div class="page-header">
        <div class="header-inner">
          <div class="header-classification">Classified</div>
          <h1 class="header-title">Unidentified <em>passengers</em></h1>
          <p class="header-desc">Flight records from the Epstein archive contain entries logged only as "FEMALE" or "MALE" — no names, no identities. These are those entries.</p>
          <div class="header-stats">
            <div class="stat-item">
              <span class="stat-num" id="statFlights">—</span>
              <span class="stat-label">Flights with unnamed passengers</span>
            </div>
            <div class="stat-divider"></div>
            <div class="stat-item">
              <span class="stat-num" id="statPersons">—</span>
              <span class="stat-label">Unidentified individuals</span>
            </div>
          </div>
        </div>
      </div>
      <!-- Methodology band -->
      <div class="methodology">
        <div class="methodology-inner">
          <span class="method-icon">◆</span>
          <p class="method-text"><strong>Source and methodology:</strong> All entries are drawn directly from pilot logbooks entered as evidence in <em>United States v. Maxwell</em> (SDNY, 2021). Passenger names were logged by the pilot. Entries appearing only as "FEMALE" or "MALE" without further identification are displayed here exactly as recorded. No editorial judgment has been applied.</p>
        </div>
      </div>
      <!-- Flight cards injected here -->
      <div class="u-main">
        <div id="uFlightContainer">
          <div class="loading-state">Loading manifest records…</div>
        </div>
        <!-- Pattern analysis -->
        <div class="pattern-block" id="uPatternBlock" style="display:none">
          <div class="pattern-title">What the pattern shows</div>
          <div class="pattern-list">
            <div class="pattern-item">
              <span class="pattern-num">01</span>
              <span><strong>Ghislaine Maxwell and Sarah Kellen are present on the vast majority of flights with unnamed female passengers.</strong> Their role as the primary organizers of Epstein's social calendar — documented extensively in the archive — places them as the most likely individuals responsible for recruiting and managing these unnamed travelers.</span>
            </div>
            <div class="pattern-item">
              <span class="pattern-num">02</span>
              <span><strong>The Clinton flight (Feb 9, 2002) remains the most scrutinized single entry.</strong> Miami to Westchester with Bill Clinton, 4 Secret Service agents, Ghislaine Maxwell, Sarah Kellen — and one unnamed female. Clinton has stated he flew on Epstein's plane four times; his team has never addressed who the unnamed passenger was.</span>
            </div>
            <div class="pattern-item">
              <span class="pattern-num">03</span>
              <span><strong>The Columbus, Ohio flight (Feb 3, 2005) is among the most legally significant.</strong> Logged three months before the Palm Beach police investigation opened, it carries Jean-Luc Brunel — the French modeling agent who died in a Paris jail in 2022 while facing rape charges — alongside Nadia Marcinko, Sarah Kellen, and three unnamed women.</span>
            </div>
            <div class="pattern-item">
              <span class="pattern-num">04</span>
              <span><strong>Unnamed females appear even on the earliest documented trips, 1998–1999.</strong> The 1998 Van Nuys to Monterey flight, carrying three unnamed women alongside Epstein and associates, predates the criminal investigation by seven years.</span>
            </div>
          </div>
        </div>
        <!-- Summary -->
        <div class="summary-section" id="uSummarySection" style="display:none">
          <div class="section-label">By the numbers</div>
          <div class="summary-grid">
            <div class="summary-cell">
              <div class="summary-cell-label">Most frequent co-travelers</div>
              <div class="summary-cell-value"><strong>Ghislaine Maxwell</strong> — present on 9 of 13 flights<br><strong>Sarah Kellen</strong> — present on 8 of 13 flights</div>
            </div>
            <div class="summary-cell">
              <div class="summary-cell-label">Routes to St. Thomas / Little Saint James</div>
              <div class="summary-cell-value">4 flights carrying unnamed female passengers flew directly to St. Thomas — the island nearest Epstein's private island.</div>
            </div>
            <div class="summary-cell">
              <div class="summary-cell-label">High-profile passengers on same flights</div>
              <div class="summary-cell-value">Bill Clinton, Jean-Luc Brunel, Glen Dubin, and Paul Mellon all appear on flights that also carried unnamed females.</div>
            </div>
            <div class="summary-cell">
              <div class="summary-cell-label">Earliest documented instance</div>
              <div class="summary-cell-value"><strong>February 18, 1998</strong> — Van Nuys to Monterey, three unnamed females, seven years before the Palm Beach investigation.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ── TAB: CONNECTIONS ── -->
    <div class="tab-panel" id="tabConnections">
      <div class="page-wrap">
        <h1 class="page-title">How are they connected?</h1>
        <p class="page-subtitle">Find the shortest documented path between any two people in the archive — through shared flights, direct relationships, and documented contacts.</p>
        <!-- Search panel -->
        <div class="search-panel">
          <div class="search-field">
            <span class="search-label">Person A</span>
            <div class="search-input-wrap">
              <input class="search-input" id="connInputA" placeholder="e.g. Bill Clinton" autocomplete="off" spellcheck="false">
              <div class="autocomplete-list" id="connDropA"></div>
            </div>
          </div>
          <div class="connector-label">→</div>
          <div class="search-field">
            <span class="search-label">Person B</span>
            <div class="search-input-wrap">
              <input class="search-input" id="connInputB" placeholder="e.g. Kevin Spacey" autocomplete="off" spellcheck="false">
              <div class="autocomplete-list" id="connDropB"></div>
            </div>
          </div>
        </div>
        <button class="search-btn" id="connFindBtn" onclick="connFindPath()" disabled>Find Connection</button>
        <!-- Quick pairs -->
        <div style="margin-top:1.25rem;">
          <div class="quick-label">Try these</div>
          <div class="quick-pairs" id="connQuickPairs">
            <div class="quick-pair" onclick="connSetQuick('Bill Clinton','Kevin Spacey')">Clinton → Spacey</div>
            <div class="quick-pair" onclick="connSetQuick('Bill Gates','Ghislaine Maxwell')">Gates → Maxwell</div>
            <div class="quick-pair" onclick="connSetQuick('Prince Andrew, Duke of York','Virginia Giuffre')">Prince Andrew → Giuffre</div>
            <div class="quick-pair" onclick="connSetQuick('Larry Summers','Jean-Luc Brunel')">Summers → Brunel</div>
            <div class="quick-pair" onclick="connSetQuick('Steven Pinker','Bill Clinton')">Pinker → Clinton</div>
            <div class="quick-pair" onclick="connSetQuick('Alan Dershowitz','Sarah Kellen')">Dershowitz → Kellen</div>
            <div class="quick-pair" onclick="connSetQuick('Chris Tucker','Ghislaine Maxwell')">Tucker → Maxwell</div>
            <div class="quick-pair" onclick="connSetQuick('Elon Musk','Steve Bannon')">Musk → Bannon</div>
          </div>
        </div>
        <!-- Result area -->
        <div id="connResultArea"></div>
      </div>
    </div>

  </main>

  <!-- RIGHT PANEL -->
  <aside class="sidebar-right" id="rightPanel">

    <!-- ── PERSON PROFILE panels ── -->
    <div class="panel-card" id="powerPanel" style="display:none">
      <div class="panel-card-title">Power Index</div>
      <div class="power-row"><span class="power-label">Public Profile</span><div class="power-track"><div class="power-fill" id="pw0" style="width:0%"></div></div><span class="power-val" id="pv0">—</span></div>
      <div class="power-row"><span class="power-label">Institutional</span><div class="power-track"><div class="power-fill" id="pw1" style="width:0%"></div></div><span class="power-val" id="pv1">—</span></div>
      <div class="power-row"><span class="power-label">Network Centrality</span><div class="power-track"><div class="power-fill" id="pw2" style="width:0%"></div></div><span class="power-val" id="pv2">—</span></div>
      <div class="power-row"><span class="power-label">Corroboration</span><div class="power-track"><div class="power-fill" id="pw3" style="width:0%"></div></div><span class="power-val" id="pv3">—</span></div>
    </div>
    <div id="coPresentPanel" style="display:none" class="panel-card">
      <div class="panel-card-title">Co-Present Persons — Top Connections</div>
      <div id="coPresentContent"></div>
    </div>
    <div id="locationsPanel" style="display:none" class="panel-card">
      <div class="panel-card-title">Locations — Documented Presence</div>
      <div id="locationsContent"></div>
    </div>
    <div id="sourceDocsPanel" style="display:none" class="panel-card">
      <div class="panel-card-title">Source Documents</div>
      <div id="sourceDocsContent"></div>
    </div>

    <!-- ── FLIGHT MANIFESTS panels ── -->
    <div id="flightStatsPanel" style="display:none" class="panel-card">
      <div class="panel-card-title">Archive Overview</div>
      <div id="flightStatsContent"></div>
    </div>
    <div id="flightRoutesPanel" style="display:none" class="panel-card">
      <div class="panel-card-title">Most Frequent Routes</div>
      <div id="flightRoutesContent"></div>
    </div>
    <div id="flightTravelersPanel" style="display:none" class="panel-card">
      <div class="panel-card-title">Most Frequent Travelers</div>
      <div id="flightTravelersContent"></div>
    </div>

    <!-- ── CONNECTIONS panels ── -->
    <div id="connPanelA" style="display:none" class="panel-card">
      <div class="panel-card-title" id="connPanelATitle">Person A</div>
      <div id="connPanelAContent"></div>
    </div>
    <div id="connPanelB" style="display:none" class="panel-card">
      <div class="panel-card-title" id="connPanelBTitle">Person B</div>
      <div id="connPanelBContent"></div>
    </div>
    <div id="connPathPanel" style="display:none" class="panel-card">
      <div class="panel-card-title">Path Summary</div>
      <div id="connPathContent"></div>
    </div>

  </aside>

</div>

<!-- MOBILE DRAWER -->
<div class="mobile-drawer" id="mobileDrawer">
  <div class="drawer-overlay" onclick="closeDrawer()"></div>
  <div class="drawer-panel">
    <div class="drawer-close"><button onclick="closeDrawer()">✕ Close</button></div>
    <div class="sidebar-section">
      <div class="sidebar-label">Query Type</div>
      <div class="nav-item" onclick="switchTab('profiles'); document.getElementById('searchInput').value=''; document.getElementById('globalSearchClear').style.display='none'; if(typeof closeGSD==='function')closeGSD(); showLanding(); closeDrawer()"><span>Person Profile</span></div>
      <div class="nav-item" onclick="switchTab('flights');closeDrawer()"><span>Flight Manifests</span></div>
      <div class="nav-item" onclick="window.location.href='graph.html'"><span>Network Graph</span><span class="coming-soon-badge" style="background:rgba(26,107,60,0.12);color:#1A6B3C;border-color:rgba(26,107,60,0.3);">LIVE</span></div>
      <div class="nav-item" onclick="switchTab('unidentified');closeDrawer()"><span>Unidentified</span><span class="coming-soon-badge" style="background:rgba(180,40,40,0.1);color:#B42828;border-color:rgba(180,40,40,0.3);">NEW</span></div>
      <div class="nav-item" onclick="switchTab('connections');closeDrawer()"><span>Connections</span><span class="coming-soon-badge" style="background:rgba(26,26,26,0.08);color:#444;border-color:rgba(26,26,26,0.2);">NEW</span></div>
      <div class="nav-item coming-soon"><span>Location Map</span><span class="coming-soon-badge">SOON</span></div>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-label">Category</div>
      <div class="nav-item filter-item-m" data-filter="category" data-value="finance"><span>Finance</span></div>
      <div class="nav-item filter-item-m" data-filter="category" data-value="politics"><span>Politics</span></div>
      <div class="nav-item filter-item-m" data-filter="category" data-value="technology"><span>Technology</span></div>
      <div class="nav-item filter-item-m" data-filter="category" data-value="legal"><span>Legal</span></div>
      <div class="nav-item filter-item-m" data-filter="category" data-value="academia"><span>Academia</span></div>
      <div class="nav-item filter-item-m" data-filter="category" data-value="entertainment"><span>Entertainment</span></div>
      <div class="nav-item filter-item-m" data-filter="category" data-value="royalty"><span>Royalty</span></div>
      <div class="nav-item filter-item-m" data-filter="category" data-value="media"><span>Media</span></div>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-label">Relationship</div>
      <div class="nav-item filter-item-m" data-filter="relationship" data-value="direct_contact"><span>Direct Contact</span></div>
      <div class="nav-item filter-item-m" data-filter="relationship" data-value="employee"><span>Employee / Staff</span></div>
      <div class="nav-item filter-item-m" data-filter="relationship" data-value="alleged_client"><span>Alleged Client</span></div>
      <div class="nav-item filter-item-m" data-filter="relationship" data-value="victim"><span>Victim / Survivor</span></div>
      <div class="nav-item filter-item-m" data-filter="relationship" data-value="legal_counsel"><span>Legal Counsel</span></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>

const SUPABASE_URL = 'https://gljuffkufkggynlaoyim.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdsanVmZmt1ZmtnZ3lubGFveWltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NDQxNzAsImV4cCI6MjA4NzUyMDE3MH0.TYRbhgiWOFp-Zc5LysfySLR8NeVQdZ9_zh6TpYyNQJE';
const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ── THEME ──
// ── MOBILE DRAWER ──
function openDrawer() { document.getElementById('mobileDrawer').classList.add('open'); }
function closeDrawer() { document.getElementById('mobileDrawer').classList.remove('open'); }

// ── TAB SWITCHING ──
let currentTab = 'profiles';
let unidentifiedLoaded = false;
let connectionsLoaded = false;

function switchTab(tab) {
  document.querySelectorAll('.tab-panel').forEach(el => el.classList.remove('active'));
  ['navProfiles','navFlights','navUnidentified','navConnections'].forEach(id => {
    const el = document.getElementById(id); if (el) el.classList.remove('active');
  });

  const filterSections = document.getElementById('sidebarFilters');
  const relFilterSections = document.getElementById('sidebarRelFilters');
  const rightPanel = document.getElementById('rightPanel');

  // Hide all right panel cards first
  const allPanelCards = ['powerPanel','coPresentPanel','locationsPanel','sourceDocsPanel',
    'flightStatsPanel','flightRoutesPanel','flightTravelersPanel',
    'connPanelA','connPanelB','connPathPanel'];
  allPanelCards.forEach(id => { const el=document.getElementById(id); if(el) el.style.display='none'; });

  if (tab === 'profiles') {
    document.getElementById('tabProfiles').classList.add('active');
    document.getElementById('navProfiles').classList.add('active');
    filterSections.style.display = '';
    relFilterSections.style.display = '';
    rightPanel.style.display = '';
    document.getElementById('searchInput').style.display = '';
  } else if (tab === 'flights') {
    document.getElementById('tabProfiles').classList.add('active');
    document.getElementById('navFlights').classList.add('active');
    filterSections.style.display = '';
    relFilterSections.style.display = '';
    rightPanel.style.display = '';
    showFlightBrowser();
    showFlightSidebarStats();
  } else if (tab === 'unidentified') {
    document.getElementById('tabUnidentified').classList.add('active');
    document.getElementById('navUnidentified').classList.add('active');
    filterSections.style.display = 'none';
    relFilterSections.style.display = 'none';
    rightPanel.style.display = 'none';
    if (!unidentifiedLoaded) { initUnidentified(); unidentifiedLoaded = true; }
  } else if (tab === 'connections') {
    document.getElementById('tabConnections').classList.add('active');
    document.getElementById('navConnections').classList.add('active');
    filterSections.style.display = 'none';
    relFilterSections.style.display = 'none';
    rightPanel.style.display = '';
    if (!connectionsLoaded) { initConnections(); connectionsLoaded = true; }
    // Show connection panels (A and B appear once people are selected)
  }
  currentTab = tab;
}

// ── FILTER ITEMS ──
document.querySelectorAll('.filter-item-m').forEach(el => {
  el.addEventListener('click', () => {
    closeDrawer();
    switchTab('profiles');
    document.querySelectorAll('.filter-item, .filter-item-m').forEach(x => x.classList.remove('active'));
    el.classList.add('active');
    searchInput.value = '';
    globalSearchClear.style.display = 'none';
    closeGSD();
    browseByFilter(el.dataset.filter, el.dataset.value);
  });
});

const searchInput = document.getElementById('searchInput');
const globalSearchRow = document.getElementById('globalSearchRow');
const globalSearchDropdown = document.getElementById('globalSearchDropdown');
const globalSearchClear = document.getElementById('globalSearchClear');

let searchTimeout;
let gsdFocusedIndex = -1;
let gsdItems = [];

// ── GLOBAL SEARCH ENGINE ──
searchInput.addEventListener('focus', () => {
  if (searchInput.value.trim().length > 1) openGSD();
});

searchInput.addEventListener('input', e => {
  clearTimeout(searchTimeout);
  const q = e.target.value.trim();
  globalSearchClear.style.display = q.length > 0 ? '' : 'none';
  document.querySelectorAll('.filter-item, .filter-item-m').forEach(el => el.classList.remove('active'));
  if (q.length < 2) { closeGSD(); if (q.length === 0) showLanding(); return; }
  searchTimeout = setTimeout(() => runGlobalSearch(q), 300);
});

searchInput.addEventListener('keydown', e => {
  if (e.key === 'Escape') { clearGlobalSearch(); return; }
  if (!globalSearchDropdown.classList.contains('open')) {
    if (e.key === 'Enter') { const q = searchInput.value.trim(); if (q.length > 1) runGlobalSearch(q); }
    return;
  }
  if (e.key === 'ArrowDown') {
    e.preventDefault();
    gsdFocusedIndex = Math.min(gsdFocusedIndex + 1, gsdItems.length - 1);
    updateGSDFocus();
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    gsdFocusedIndex = Math.max(gsdFocusedIndex - 1, 0);
    updateGSDFocus();
  } else if (e.key === 'Enter') {
    e.preventDefault();
    if (gsdFocusedIndex >= 0 && gsdItems[gsdFocusedIndex]) {
      gsdItems[gsdFocusedIndex].click();
    }
  }
});

document.addEventListener('click', e => {
  if (!document.getElementById('globalSearchWrap').contains(e.target)) closeGSD();
});

function openGSD() {
  globalSearchDropdown.classList.add('open');
  globalSearchRow.classList.add('active');
}
function closeGSD() {
  globalSearchDropdown.classList.remove('open');
  globalSearchRow.classList.remove('active');
  gsdFocusedIndex = -1;
  gsdItems = [];
}
function clearGlobalSearch() {
  searchInput.value = '';
  globalSearchClear.style.display = 'none';
  closeGSD();
  showLanding();
  searchInput.focus();
}
function updateGSDFocus() {
  gsdItems.forEach((el, i) => {
    el.classList.toggle('focused', i === gsdFocusedIndex);
    if (i === gsdFocusedIndex) el.scrollIntoView({ block: 'nearest' });
  });
}

function highlightMatch(text, query) {
  if (!text) return '';
  const escaped = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  return text.replace(new RegExp(`(${escaped})`, 'gi'), '<mark>$1</mark>');
}

async function runGlobalSearch(q) {
  openGSD();
  globalSearchDropdown.innerHTML = `<div class="gsd-loading">Searching archive…</div>`;
  gsdItems = [];
  gsdFocusedIndex = -1;

  try {
    // Run all 4 searches in parallel
    const [personsRes, docsRes, eventsRes, flightsRes] = await Promise.allSettled([
      db.from('persons')
        .select('id, full_name, category, relationship_to_epstein, confidence, public_title')
        .ilike('full_name', `%${q}%`)
        .eq('is_victim', false)
        .order('total_document_count', { ascending: false })
        .limit(5),
      db.from('documents')
        .select('id, title, document_type, document_date, doc_reference_id')
        .ilike('title', `%${q}%`)
        .limit(4),
      db.from('events')
        .select('id, event_name, event_date, location_id, event_type')
        .ilike('event_name', `%${q}%`)
        .limit(4),
      db.from('flights')
        .select('id, flight_date, origin, destination, tail_number')
        .or(`origin.ilike.%${q}%,destination.ilike.%${q}%,tail_number.ilike.%${q}%`)
        .order('flight_date', { ascending: false })
        .limit(4)
    ]);

    const persons = personsRes.status === 'fulfilled' ? (personsRes.value.data || []) : [];
    const docs = docsRes.status === 'fulfilled' ? (docsRes.value.data || []) : [];
    const events = eventsRes.status === 'fulfilled' ? (eventsRes.value.data || []) : [];
    const flights = flightsRes.status === 'fulfilled' ? (flightsRes.value.data || []) : [];

    const total = persons.length + docs.length + events.length + flights.length;
    if (total === 0) {
      globalSearchDropdown.innerHTML = `<div class="gsd-empty">No results for "${q}"</div>`;
      return;
    }

    let html = '';

    if (persons.length > 0) {
      html += `<div class="gsd-section-label">Persons</div>`;
      persons.forEach(p => {
        const cat = p.category ? cap(p.category) : '';
        const rel = p.relationship_to_epstein ? cap(p.relationship_to_epstein.replace(/_/g,' ')) : '';
        const sub = [cat, rel].filter(Boolean).join(' · ');
        html += `<div class="gsd-item" data-type="person" data-id="${p.id}" data-name="${p.full_name}">
          <span class="gsd-icon">👤</span>
          <div class="gsd-main">
            <div class="gsd-name">${highlightMatch(p.full_name, q)}</div>
            ${sub ? `<div class="gsd-sub">${sub}</div>` : ''}
          </div>
          <span class="gsd-badge person">${p.confidence || 'indicated'}</span>
        </div>`;
      });
    }

    if (docs.length > 0) {
      html += `<div class="gsd-section-label">Documents</div>`;
      docs.forEach(d => {
        const date = d.document_date ? d.document_date.substring(0,4) : '';
        const type = d.document_type ? cap(d.document_type.replace(/_/g,' ')) : '';
        const sub = [type, date].filter(Boolean).join(' · ');
        html += `<div class="gsd-item" data-type="document" data-id="${d.id}" data-ref="${d.doc_reference_id || ''}">
          <span class="gsd-icon">📄</span>
          <div class="gsd-main">
            <div class="gsd-name">${highlightMatch(d.title, q)}</div>
            ${sub ? `<div class="gsd-sub">${sub}</div>` : ''}
          </div>
          <span class="gsd-badge document">Doc</span>
        </div>`;
      });
    }

    if (events.length > 0) {
      html += `<div class="gsd-section-label">Events</div>`;
      events.forEach(ev => {
        const date = ev.event_date ? ev.event_date.substring(0,10) : '';
        const type = ev.event_type ? cap(ev.event_type.replace(/_/g,' ')) : '';
        const sub = [type, date].filter(Boolean).join(' · ');
        html += `<div class="gsd-item" data-type="event" data-id="${ev.id}">
          <span class="gsd-icon">📅</span>
          <div class="gsd-main">
            <div class="gsd-name">${highlightMatch(ev.event_name, q)}</div>
            ${sub ? `<div class="gsd-sub">${sub}</div>` : ''}
          </div>
          <span class="gsd-badge event">Event</span>
        </div>`;
      });
    }

    if (flights.length > 0) {
      html += `<div class="gsd-section-label">Flights</div>`;
      flights.forEach(f => {
        const date = f.flight_date ? f.flight_date.substring(0,10) : '';
        const route = [f.origin, f.destination].filter(Boolean).join(' → ');
        html += `<div class="gsd-item" data-type="flight" data-id="${f.id}" data-date="${date}">
          <span class="gsd-icon">✈</span>
          <div class="gsd-main">
            <div class="gsd-name">${highlightMatch(route || f.tail_number, q)}</div>
            <div class="gsd-sub">${date}${f.tail_number ? ' · ' + f.tail_number : ''}</div>
          </div>
          <span class="gsd-badge flight">Flight</span>
        </div>`;
      });
    }

    html += `<div class="gsd-footer">
      <span class="gsd-footer-hint">${total} result${total !== 1 ? 's' : ''} across archive</span>
      <span class="gsd-footer-hint"><kbd>↑↓</kbd> navigate &nbsp; <kbd>↵</kbd> select &nbsp; <kbd>esc</kbd> close</span>
    </div>`;

    globalSearchDropdown.innerHTML = html;

    // Attach click handlers
    gsdItems = Array.from(globalSearchDropdown.querySelectorAll('.gsd-item'));
    gsdItems.forEach(item => {
      item.addEventListener('click', () => handleGSDSelect(item));
      item.addEventListener('mouseenter', () => {
        gsdFocusedIndex = gsdItems.indexOf(item);
        updateGSDFocus();
      });
    });

  } catch(err) {
    globalSearchDropdown.innerHTML = `<div class="gsd-empty">Search error — ${err.message}</div>`;
  }
}

function handleGSDSelect(item) {
  const type = item.dataset.type;
  closeGSD();

  if (type === 'person') {
    const name = item.dataset.name;
    searchInput.value = name;
    globalSearchClear.style.display = '';
    switchTab('profiles');
    document.querySelectorAll('.filter-item, .filter-item-m').forEach(el => el.classList.remove('active'));
    searchPersons(name);
  } else if (type === 'document') {
    searchInput.value = '';
    globalSearchClear.style.display = 'none';
    // Switch to documents tab and highlight this doc
    const docRef = item.dataset.ref;
    switchTab('profiles');
    const navDocs = document.getElementById('navDocuments');
    if (navDocs) navDocs.click();
    else {
      // Fallback: switch to documents tab directly
      setTimeout(() => {
        const el = document.querySelector('[onclick*="documents"]');
        if (el) el.click();
      }, 100);
    }
    // Open the document tab and filter
    if (typeof switchToDocumentsTab === 'function') {
      switchToDocumentsTab(item.dataset.id);
    } else {
      openTabAndHighlightDoc(item.dataset.id);
    }
  } else if (type === 'event') {
    searchInput.value = '';
    globalSearchClear.style.display = 'none';
    openTabAndHighlightEvent(item.dataset.id);
  } else if (type === 'flight') {
    searchInput.value = '';
    globalSearchClear.style.display = 'none';
    switchTab('flights');
    // Show flight detail
    if (item.dataset.id) setTimeout(() => showFlightDetail(item.dataset.id), 400);
  }
}

function openTabAndHighlightDoc(docId) {
  // Navigate to the Documents tab in the nav and filter to this document
  const docNav = Array.from(document.querySelectorAll('.nav-item')).find(el => el.textContent.trim().includes('Document'));
  if (docNav) {
    docNav.click();
    setTimeout(() => {
      const row = document.querySelector(`[data-doc-id="${docId}"]`);
      if (row) { row.scrollIntoView({ behavior: 'smooth', block: 'center' }); row.click(); }
    }, 500);
  }
}

function openTabAndHighlightEvent(eventId) {
  const evNav = Array.from(document.querySelectorAll('.nav-item')).find(el => el.textContent.trim().includes('Timeline') || el.textContent.trim().includes('Evidence'));
  if (evNav) {
    evNav.click();
    setTimeout(() => {
      const row = document.querySelector(`[data-event-id="${eventId}"]`);
      if (row) { row.scrollIntoView({ behavior: 'smooth', block: 'center' }); row.classList.add('highlight-flash'); }
    }, 500);
  }
}

document.querySelectorAll('.filter-item').forEach(el => {
  el.addEventListener('click', () => {
    const wasActive = el.classList.contains('active');
    document.querySelectorAll('.filter-item, .filter-item-m').forEach(x => x.classList.remove('active'));
    if (!wasActive) {
      el.classList.add('active');
      searchInput.value = '';
      globalSearchClear.style.display = 'none';
      closeGSD();
      browseByFilter(el.dataset.filter, el.dataset.value);
    } else {
      showLanding();
    }
  });
});

function doSearch(name) {
  switchTab('profiles');
  searchInput.value = name;
  globalSearchClear.style.display = '';
  searchPersons(name);
}

// ── PROFILES JS ──
async function searchPersons(query) {
  showProfilesLoading();
  try {
    const { data, error } = await db
      .from('persons')
      .select('id, full_name, confidence, category, relationship_to_epstein, public_title, total_document_count, power_public_profile, power_institutional, power_network_centrality, power_corroboration, current_status, notes, nationality, active_period_start, active_period_end, upgrade_gap_note')
      .ilike('full_name', `%${query}%`)
      .eq('is_victim', false)
      .order('total_document_count', { ascending: false })
      .limit(20);
    if (error) throw error;
    if (!data || data.length === 0) showEmpty(query);
    else if (data.length === 1) renderProfile(data[0]);
    else showResults(data, query);
  } catch(err) { showError(err.message); }
}

async function browseByFilter(field, value) {
  showProfilesLoading();
  const col = field === 'category' ? 'category' : 'relationship_to_epstein';
  try {
    const { data, error } = await db
      .from('persons')
      .select('id, full_name, confidence, category, relationship_to_epstein, public_title, total_document_count, power_public_profile, power_institutional, power_network_centrality, power_corroboration, current_status, notes, nationality, active_period_start, active_period_end, upgrade_gap_note')
      .eq(col, value)
      .eq('is_victim', false)
      .order('total_document_count', { ascending: false })
      .limit(50);
    if (error) throw error;
    if (!data || data.length === 0) showEmpty(value);
    else showResults(data, value.replace(/_/g,' '));
  } catch(err) { showError(err.message); }
}

function renderProfile(p) {
  const tabEl = document.getElementById('tabProfiles');
  const notes = p.notes || '';
  const summary = notes.replace(/\[jwiki:[^\]]+\]\s*/, '');
  const safeSummary = summary.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  const emailCount = p.total_document_count || 0;
  const rel = p.relationship_to_epstein || 'associate';
  const conf = p.confidence || 'indicated';
  const slug = notes.match(/\[jwiki:([^\]]+)\]/)?.[1] || '';
  const activeStart = p.active_period_start ? String(p.active_period_start).substring(0,4) : null;
  const activeEnd = p.active_period_end ? String(p.active_period_end).substring(0,4) : null;
  const activePeriod = activeStart ? `Active ${activeStart}${activeEnd && activeEnd !== activeStart ? '–'+activeEnd : ''}` : null;

  tabEl.innerHTML = `
    <div style="padding:1.5rem 1.75rem;">
      <!-- Header -->
      <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:1rem;margin-bottom:0.75rem;">
        <div>
          <div class="subject-name">${p.full_name}</div>
          <div class="subject-meta" style="margin-top:0.5rem;">
            ${emailCount > 0 ? `<span class="meta-pill">${emailCount.toLocaleString()} Documents</span>` : ''}
            ${p.category ? `<span class="meta-pill">${cap(p.category)}</span>` : ''}
            ${activePeriod ? `<span class="meta-pill">${activePeriod}</span>` : ''}
            ${p.current_status ? `<span class="meta-pill">${cap(p.current_status)}</span>` : ''}
          </div>
        </div>
        <span class="conf-badge ${conf}" style="flex-shrink:0;margin-top:0.25rem;">● ${cap(conf)}</span>
      </div>

      <!-- Stat cards -->
      <div class="stats-row" style="margin-bottom:1.5rem;">
        <div class="stat-card"><div class="stat-value">${emailCount.toLocaleString()}</div><div class="stat-label">Total Documents</div></div>
        <div class="stat-card"><div class="stat-value" id="statLocations">—</div><div class="stat-label">Locations</div></div>
        <div class="stat-card"><div class="stat-value" id="statCoPax">—</div><div class="stat-label">Co-Present Persons</div></div>
        <div class="stat-card"><div class="stat-value" id="statYearsActive">—</div><div class="stat-label">Years Active in Files</div></div>
      </div>

      <!-- Intelligence Summary -->
      ${safeSummary ? `<div style="margin-bottom:1.5rem;"><div class="section-title">Intelligence Summary</div><div class="profile-summary">${safeSummary}</div></div>` : ''}

      <!-- Timeline (populated async) -->
      <div id="timelineSection">
        <div class="section-title">Event Timeline — Flight Record</div>
        <div id="timelineContent" style="padding:1.5rem;text-align:center;background:var(--surface);border:1px dashed var(--border);border-radius:10px;">
          <div style="font-family:'Montserrat',sans-serif;font-size:0.72rem;color:var(--text-tertiary);letter-spacing:0.1em;">LOADING MANIFEST DATA...</div>
        </div>
      </div>

      <!-- Evidence gap (populated async) -->
      <div id="evidenceGap"></div>
    </div>
  `;

  // Populate right panel — Power Index
  const pw = [p.power_public_profile, p.power_institutional, p.power_network_centrality, p.power_corroboration];
  const pl = ['pw0','pw1','pw2','pw3'];
  const vl = ['pv0','pv1','pv2','pv3'];
  pw.forEach((v,i) => {
    document.getElementById(pl[i]).style.width = (v||0)+'%';
    document.getElementById(vl[i]).textContent = v||'—';
  });
  document.getElementById('powerPanel').style.display = 'block';
  document.getElementById('coPresentPanel').style.display = 'none';
  document.getElementById('locationsPanel').style.display = 'none';
  document.getElementById('sourceDocsPanel').style.display = 'none';

  fetchFlights(p.id, p.full_name, conf, p.upgrade_gap_note, emailCount);
}

async function fetchFlights(personId, personName, conf, upgradeGapNote, emailCount) {
  const el = document.getElementById('timelineContent');
  if (!el) return;
  try {
    const AL = {'TEB':'Teterboro, NJ','PBI':'Palm Beach, FL','TIST':'St. Thomas, USVI','JFK':'New York JFK','EWR':'Newark, NJ','LGA':'New York LGA','HPN':'White Plains, NY','MIA':'Miami, FL','SAF':'Santa Fe, NM','BOS':'Boston, MA','LAX':'Los Angeles, CA','VNY':'Van Nuys, CA','MVY':"Martha's Vineyard",'MRY':'Monterey, CA','CMH':'Columbus, OH','JAX':'Jacksonville, FL','ABQ':'Albuquerque, NM','BED':'Bedford, MA','BGR':'Bangor, ME','ABY':'Albany, GA','MYEF':'Great Exuma, Bahamas','LFPB':'Paris, France','LFMN':'Nice, France','EGBB':'Birmingham, UK','EGGW':'London Luton','ESSA':'Stockholm','EIDW':'Dublin','GMTT':'Tangier, Morocco','MBPV':'Turks & Caicos','DCA':'Washington, DC','IAD':'Dulles, VA','ASE':'Aspen, CO','LAS':'Las Vegas, NV','MDW':'Chicago, IL','HTO':'East Hampton, NY','RIC':'Richmond, VA','TNCM':'St. Maarten','MYNN':'Nassau, Bahamas'};
    const loc = code => AL[code] || code;
    const isIsland = code => ['TIST','MYEF','MBPV','TNCM','MYNN'].includes(code);
    const fmt = d => new Date(d+'T12:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
    const fmtShort = d => { const dt = new Date(d+'T12:00:00'); return dt.toLocaleDateString('en-US',{month:'short',day:'numeric'})+'\n'+dt.getFullYear(); };

    // Fetch this person's flight_passenger records
    const { data: fps } = await db.from('flight_passengers').select('flight_id,name_as_logged').eq('person_id', personId);
    if (!fps || fps.length === 0) {
      el.innerHTML = `<div style="font-size:0.82rem;color:var(--text-secondary);padding:1rem 0;">No documented flights found for this individual in the current manifest database.</div>`;
      document.getElementById('statYearsActive') && (document.getElementById('statYearsActive').textContent = '0');
      document.getElementById('statLocations') && (document.getElementById('statLocations').textContent = '0');
      document.getElementById('statCoPax') && (document.getElementById('statCoPax').textContent = '0');
      // Still show empty right panel cards
      document.getElementById('coPresentPanel').style.display = 'block';
      document.getElementById('coPresentContent').innerHTML = `<div style="font-family:'Montserrat',sans-serif;font-size:0.72rem;color:var(--text-tertiary);padding:0.5rem 0;">No co-present persons documented in flight records.</div>`;
      document.getElementById('locationsPanel').style.display = 'block';
      document.getElementById('locationsContent').innerHTML = `<div style="font-family:'Montserrat',sans-serif;font-size:0.72rem;color:var(--text-tertiary);padding:0.5rem 0;">No flight location data available.</div>`;
      document.getElementById('sourceDocsPanel').style.display = 'block';
      document.getElementById('sourceDocsContent').innerHTML = `<div style="font-family:'Montserrat',sans-serif;font-size:0.72rem;color:var(--text-tertiary);padding:0.5rem 0;">Source: Epstein email archive · ${emailCount.toLocaleString()} documents indexed.</div>`;
      return;
    }

    const flightIds = fps.map(fp => fp.flight_id);

    // Fetch flights + all co-passengers in parallel
    const [{ data: flights }, { data: allFPs }, { data: allPersons }] = await Promise.all([
      db.from('flights').select('id,flight_date,tail_number,origin,destination,notes').in('id', flightIds).order('flight_date',{ascending:true}),
      db.from('flight_passengers').select('flight_id,person_id,name_as_logged,is_identified,is_redacted').in('flight_id', flightIds),
      db.from('persons').select('id,full_name,category,relationship_to_epstein').not('id','eq',personId),
    ]);

    document.getElementById('statYearsActive') && (document.getElementById('statYearsActive').textContent = (flights||[]).length > 0 ? (() => { const yrs = [...new Set((flights||[]).map(f=>f.flight_date.substring(0,4)))]; return yrs.length > 1 ? (Math.max(...yrs)-Math.min(...yrs)+1) : 1; })() : '—');

    // Build person lookup
    const pById = {};
    (allPersons||[]).forEach(p => pById[p.id] = p);

    // Build co-passenger frequency map
    const coPaxCount = {};
    const coPaxMeta = {};
    (allFPs||[]).forEach(fp => {
      if (fp.person_id && fp.person_id !== personId && pById[fp.person_id]) {
        coPaxCount[fp.person_id] = (coPaxCount[fp.person_id] || 0) + 1;
        coPaxMeta[fp.person_id] = pById[fp.person_id];
      }
    });

    // Build location frequency map
    const locCount = {};
    (flights||[]).forEach(f => {
      [f.origin, f.destination].forEach(code => {
        if (code) locCount[code] = (locCount[code]||0) + 1;
      });
    });

    // Build per-flight co-passenger map
    const fpByFlight = {};
    (allFPs||[]).forEach(fp => {
      if (!fpByFlight[fp.flight_id]) fpByFlight[fp.flight_id] = [];
      fpByFlight[fp.flight_id].push(fp);
    });

    // Stat: unique co-present persons
    document.getElementById('statCoPax').textContent = Object.keys(coPaxCount).length;

    // Stat: unique locations
    const uniqueLocs = Object.keys(locCount).length;
    document.getElementById('statLocations').textContent = uniqueLocs;

    // === RIGHT PANEL: Co-Present Persons ===
    const sortedCoPax = Object.entries(coPaxCount).sort((a,b)=>b[1]-a[1]).slice(0,5);
    if (sortedCoPax.length > 0) {
      const maxCount = sortedCoPax[0][1];
      const relLabel = { direct_contact:'Direct Contact', employee:'Employee/Staff', alleged_client:'Alleged Client', victim:'Victim/Survivor', legal_counsel:'Legal Counsel', associate:'Associate' };
      document.getElementById('coPresentPanel').style.display = 'block';
      document.getElementById('coPresentContent').innerHTML = sortedCoPax.map(([pid, count]) => {
        const cp = coPaxMeta[pid];
        const initials = cp.full_name.split(' ').map(w=>w[0]).join('').substring(0,2).toUpperCase();
        const rel = relLabel[cp.relationship_to_epstein] || cap(cp.relationship_to_epstein||'Associate');
        const barPct = Math.round((count / maxCount) * 100);
        return `<div class="copresent-row">
          <div class="copresent-avatar">${initials}</div>
          <div class="copresent-info">
            <div class="copresent-name" onclick="loadById('${pid}')">${cp.full_name}</div>
            <div class="copresent-meta">${cap(cp.category||'')} · ${rel}</div>
          </div>
          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:3px;flex-shrink:0;min-width:70px;">
            <div style="width:60px;height:3px;background:var(--border);border-radius:2px;overflow:hidden;"><div style="width:${barPct}%;height:100%;background:var(--accent);border-radius:2px;"></div></div>
            <div class="copresent-count">${count} doc${count>1?'s':''}</div>
          </div>
        </div>`;
      }).join('');
    }

    // === RIGHT PANEL: Locations — Named Places ===
    const namedPlaces = {
      TIST: { name:'Little Saint James', sub:'Private Island · USVI', icon:'🏝' },
      MYEF: { name:'Great Exuma', sub:'Private Island · Bahamas', icon:'🏝' },
      MBPV: { name:'Turks & Caicos', sub:'Island · Caribbean', icon:'🏝' },
      TNCM: { name:'St. Maarten', sub:'Island · Caribbean', icon:'🏝' },
      MYNN: { name:'Nassau', sub:'Island · Bahamas', icon:'🏝' },
      PBI:  { name:'Palm Beach Estate', sub:'Residence · Florida', icon:'🏠' },
      TEB:  { name:'Teterboro Airport', sub:'Hub · New Jersey', icon:'✈️' },
      JFK:  { name:'New York — JFK', sub:'Airport · New York', icon:'✈️' },
      EWR:  { name:'Newark Liberty', sub:'Airport · New Jersey', icon:'✈️' },
      LGA:  { name:'LaGuardia', sub:'Airport · New York', icon:'✈️' },
      HPN:  { name:'Westchester County', sub:'Airport · New York', icon:'✈️' },
      MIA:  { name:'Miami International', sub:'Airport · Florida', icon:'✈️' },
      LAX:  { name:'Los Angeles', sub:'Airport · California', icon:'✈️' },
      VNY:  { name:'Van Nuys Airport', sub:'Private · California', icon:'✈️' },
      BOS:  { name:'Boston Logan', sub:'Airport · Massachusetts', icon:'✈️' },
      DCA:  { name:'Washington National', sub:'Airport · DC', icon:'✈️' },
      IAD:  { name:'Dulles Airport', sub:'Airport · Virginia', icon:'✈️' },
      SAF:  { name:'Santa Fe', sub:'Airport · New Mexico', icon:'✈️' },
      MVY:  { name:"Martha's Vineyard", sub:'Island · Massachusetts', icon:'🏝' },
      ASE:  { name:'Aspen', sub:'Airport · Colorado', icon:'✈️' },
      CMH:  { name:'Columbus', sub:'Airport · Ohio', icon:'✈️' },
      LFMN: { name:'Nice Côte d\'Azur', sub:'Airport · France', icon:'✈️' },
      LFPB: { name:'Paris Le Bourget', sub:'Private · France', icon:'✈️' },
      EGBB: { name:'Birmingham', sub:'Airport · UK', icon:'✈️' },
      EGGW: { name:'London Luton', sub:'Airport · UK', icon:'✈️' },
    };
    // Also add the aircraft itself as a location entry
    const tailNums = [...new Set((flights||[]).map(f=>f.tail_number).filter(Boolean))];

    const sortedLocs = Object.entries(locCount).sort((a,b)=>b[1]-a[1]).slice(0,4);
    const locRows = sortedLocs.map(([code, count]) => {
      const place = namedPlaces[code] || { name: loc(code), sub: 'Airport · '+code, icon:'📍' };
      return `<div class="location-row">
        <div class="location-icon">${place.icon}</div>
        <div class="location-info">
          <div class="location-name">${place.name}</div>
          <div class="location-meta">${place.sub}</div>
        </div>
        <div class="location-count">${count} visit${count>1?'s':''}</div>
      </div>`;
    });
    // Add aircraft row
    if (tailNums.length > 0) {
      locRows.push(`<div class="location-row">
        <div class="location-icon">✈</div>
        <div class="location-info">
          <div class="location-name">${tailNums.join(' · ')} — Lolita Express</div>
          <div class="location-meta">Private Aircraft</div>
        </div>
        <div class="location-count">${(flights||[]).length} flight${(flights||[]).length>1?'s':''}</div>
      </div>`);
    }
    document.getElementById('locationsPanel').style.display = 'block';
    document.getElementById('locationsContent').innerHTML = locRows.join('');

    // === RIGHT PANEL: Source Documents with check/dash indicators ===
    const confCircle = (c) => {
      if (c === 'confirmed') return `<div style="width:20px;height:20px;border-radius:50%;border:1px solid var(--confirmed);display:flex;align-items:center;justify-content:center;"><span style="color:var(--confirmed);font-size:0.65rem;">✓</span></div>`;
      if (c === 'corroborated') return `<div style="width:20px;height:20px;border-radius:50%;border:1px solid var(--corroborated);display:flex;align-items:center;justify-content:center;"><span style="color:var(--corroborated);font-size:0.65rem;">✓</span></div>`;
      return `<div style="width:20px;height:20px;border-radius:50%;border:1px solid var(--border-mid);display:flex;align-items:center;justify-content:center;"><span style="color:var(--text-tertiary);font-size:0.75rem;">−</span></div>`;
    };
    document.getElementById('sourceDocsPanel').style.display = 'block';
    document.getElementById('sourceDocsContent').innerHTML = (flights||[]).slice(0,5).map((f,i) => {
      const docId = `DOC-FL-${String(f.id).padStart(4,'0')}`;
      const fDate = new Date(f.flight_date+'T12:00:00').toLocaleDateString('en-US',{month:'short',year:'numeric'});
      const fConf = (isIsland(f.destination)||isIsland(f.origin)) ? 'confirmed' : conf;
      return `<div class="source-doc-row">
        <div>
          <div class="source-doc-id">${docId}</div>
          <div class="source-doc-meta">Flight Manifest · ${fDate}</div>
        </div>
        ${confCircle(fConf)}
      </div>`;
    }).join('');

    // === MAIN: Event Timeline ===
    el.innerHTML = (flights||[]).map(f => {
      const fps_this = fpByFlight[f.id] || [];
      const named = fps_this.filter(fp => fp.person_id && fp.person_id !== personId && pById[fp.person_id]).map(fp => pById[fp.person_id]).filter(Boolean);
      const redactedFps = fps_this.filter(fp => fp.is_redacted || (!fp.person_id && fp.name_as_logged));
      const island = isIsland(f.destination) || isIsland(f.origin);
      const fConf = island ? 'confirmed' : conf;
      const dt = f.flight_date;
      const yr = dt.substring(0,4);
      const dayMonth = new Date(dt+'T12:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric'});
      const tags = [
        ...named.slice(0,3).map(cp => `<span class="timeline-tag" onclick="loadById('${cp.id}')" style="cursor:pointer;">${cp.full_name.split(' ').slice(-1)[0]}</span>`),
        ...(redactedFps.length > 0 ? [`<span class="timeline-tag">[REDACTED — ${redactedFps.length} name${redactedFps.length>1?'s':''}]</span>`] : []),
        island ? `<span class="timeline-tag island">${loc(f.destination)}</span>` : `<span class="timeline-tag">${loc(f.destination)}</span>`,
        `<span class="timeline-tag" style="color:var(--text-tertiary);">DOC-FL-${String(f.id).padStart(4,'0')}</span>`,
      ];
      const coNames = named.length > 0 ? named.slice(0,3).map(cp=>cp.full_name).join(', ')+(named.length>3?`, +${named.length-3} more`:'') : null;
      const desc = coNames
        ? `Manifest lists ${personName.split(' ')[0]} alongside ${coNames}.${island ? ` Destination: ${loc(f.destination)}.` : ''}`
        : `${personName.split(' ')[0]} listed on ${f.tail_number} manifest.${island ? ` Island destination: ${loc(f.destination)}.` : ''}`;
      return `<div class="timeline-item">
        <div class="timeline-date">${dayMonth}<br><span style="font-size:0.72rem;">${yr}</span></div>
        <div class="timeline-dot ${fConf}" style="margin-top:0.85rem;"></div>
        <div class="timeline-card">
          <div class="timeline-card-header">
            <div class="timeline-card-title">Flight: ${loc(f.origin)} → ${loc(f.destination)}</div>
            <span class="conf-badge ${fConf}" style="font-size:0.6rem;padding:0.15rem 0.5rem;">● ${cap(fConf)}</span>
          </div>
          <div class="timeline-card-body">${desc}</div>
          <div class="timeline-tags">${tags.join('')}</div>
        </div>
      </div>`;
    }).join('');

    // Evidence gap banner
    if (upgradeGapNote || conf === 'corroborated' || conf === 'indicated') {
      const gapText = upgradeGapNote || `${cap(conf)} status: additional independent documentation needed to upgrade confidence level. Cross-reference available in flight manifest records.`;
      document.getElementById('evidenceGap').innerHTML = `
        <div class="evidence-gap">
          <div class="evidence-gap-label">⚠ Evidence Gap — Action Required</div>
          <div class="evidence-gap-text">${gapText}</div>
        </div>`;
    }

  } catch(err) {
    if (document.getElementById('timelineContent'))
      document.getElementById('timelineContent').innerHTML = `<div style="font-size:0.8rem;color:var(--text-secondary);">Flight data unavailable: ${err.message}</div>`;
  }
}

function showResults(persons, query) {
  clearRightPanel();
  const tabEl = document.getElementById('tabProfiles');
  tabEl.innerHTML = `
    <div style="padding:1.5rem 1.75rem;">
      <div class="section-title">${persons.length} result${persons.length !== 1 ? 's' : ''} — "${query}"</div>
      <div class="results-grid">
        ${persons.map(p => `
          <div class="result-card-profile" onclick="loadById('${p.id}')">
            <div>
              <div class="result-name">${p.full_name}</div>
              <div class="result-meta">${p.public_title || cap(p.category || 'Unknown')} · ${cap((p.relationship_to_epstein||'associate').replace(/_/g,' '))}</div>
            </div>
            <div style="display:flex;flex-direction:column;align-items:flex-end;gap:0.4rem;">
              <span class="conf-badge ${p.confidence||'indicated'}">${cap(p.confidence||'indicated')}</span>
              <div class="result-docs">${(p.total_document_count||0).toLocaleString()} emails</div>
            </div>
          </div>`).join('')}
      </div>
    </div>`;
}

async function loadById(id) {
  showProfilesLoading();
  const { data } = await db.from('persons').select('*').eq('id', id).single();
  if (data) renderProfile(data);
}

async function showFlightBrowser() {
  clearRightPanel();
  showProfilesLoading();
  try {
    const AL = {'TEB':'Teterboro, NJ','PBI':'Palm Beach, FL','TIST':'St. Thomas, USVI','JFK':'New York JFK','EWR':'Newark, NJ','LGA':'New York LGA','HPN':'White Plains, NY','MIA':'Miami, FL','SAF':'Santa Fe, NM','BOS':'Boston, MA','LAX':'Los Angeles, CA','VNY':'Van Nuys, CA','MVY':"Martha's Vineyard",'MRY':'Monterey, CA','CMH':'Columbus, OH','JAX':'Jacksonville, FL','ABQ':'Albuquerque, NM','BED':'Bedford, MA','BGR':'Bangor, ME','ABY':'Albany, GA','MYEF':'Great Exuma, Bahamas','LFPB':'Paris, France','LFML':'Marseille, France','LFMN':'Nice, France','EGBB':'Birmingham, UK','EGGW':'London Luton','ESSA':'Stockholm','EIDW':'Dublin','GMTT':'Tangier, Morocco','GMME':'Rabat, Morocco','LPAZ':'Azores, Portugal','MBPV':'Turks & Caicos','DCA':'Washington, DC','IAD':'Dulles, VA','ASE':'Aspen, CO','LAS':'Las Vegas, NV','MDW':'Chicago, IL','HTO':'East Hampton, NY','RIC':'Richmond, VA','TNCM':'St. Maarten','MYNN':'Nassau, Bahamas'};
    const loc = code => AL[code] || code;
    const isIsland = code => ['TIST','MYEF','MBPV','TNCM','MYNN'].includes(code);
    const fmt = d => new Date(d+'T12:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});

    // Load flights + all passengers in parallel
    const [flightsRes, fpsRes, personsRes] = await Promise.all([
      db.from('flights').select('id,flight_date,tail_number,aircraft_type,origin,destination,notes').order('flight_date',{ascending:true}),
      db.from('flight_passengers').select('flight_id,person_id,name_as_logged,is_identified,is_redacted'),
      db.from('persons').select('id,full_name,category,relationship_to_epstein'),
    ]);

    if (flightsRes.error) throw flightsRes.error;
    const flights = flightsRes.data || [];
    const allFPs = fpsRes.data || [];
    const allPersons = personsRes.data || [];

    // Build lookup maps
    const personById = {};
    (allPersons||[]).forEach(p => personById[p.id] = p);
    const fpByFlight = {};
    (allFPs||[]).forEach(fp => {
      if (!fpByFlight[fp.flight_id]) fpByFlight[fp.flight_id] = [];
      fpByFlight[fp.flight_id].push(fp);
    });

    const relColor = { direct_contact:'var(--confirmed)', employee:'var(--corroborated)', alleged_client:'var(--indicated)', victim:'var(--corroborated)', legal_counsel:'var(--indicated)', associate:'var(--text-tertiary)' };

    const rowsHtml = (flights||[]).map(f => {
      const fps = fpByFlight[f.id] || [];
      const named = fps.filter(fp => fp.is_identified && fp.person_id).map(fp => personById[fp.person_id]).filter(Boolean);
      const redacted = fps.filter(fp => fp.is_redacted);
      // count unnamed from notes
      const unnamedMatches = (f.notes||'').match(/(\d+)\s+(FEMALE|MALE)/gi) || [];
      const unnamedCount = unnamedMatches.reduce((s,m) => { const n=parseInt(m); return s+(isNaN(n)?1:n); }, unnamedMatches.length>0?0:0);
      const totalPax = named.length + (unnamedMatches.length > 0 ? unnamedMatches.reduce((s,m)=>{ const parts=m.trim().split(/\s+/); return s+parseInt(parts[0]||1); },0) : 0);
      const highlight = isIsland(f.destination) || isIsland(f.origin);

      // Build manifest HTML (hidden by default)
      const manifestHtml = `
        <div class="fm-manifest" id="fm-${f.id}" style="display:none;">
          <div class="fm-manifest-inner">
            <div class="fm-manifest-label">Full passenger manifest</div>
            <div class="fm-pax-list">
              ${named.map(p => {
                const rel = p.relationship_to_epstein || 'associate';
                const col = relColor[rel] || 'var(--text-tertiary)';
                const safeName = (p.full_name||'').replace(/'/g,"\\'").replace(/"/g,'&quot;');
                return `<div class="fm-pax-row" onclick="doSearch('${safeName}');switchTab('profiles');" title="View profile">
                  <span class="fm-pax-dot" style="background:${col};"></span>
                  <span class="fm-pax-name">${p.full_name}</span>
                  <span class="fm-pax-meta">${cap(rel.replace(/_/g,' '))} · ${cap(p.category||'')}</span>
                  <span class="fm-pax-arrow">→</span>
                </div>`;
              }).join('')}
              ${unnamedMatches.map(m => {
                const parts = m.trim().split(/\s+/);
                const n = parseInt(parts[0])||1;
                const gender = parts[1]||'FEMALE';
                return `<div class="fm-pax-row fm-pax-redacted" style="cursor:default;">
                  <span class="fm-pax-dot" style="background:var(--text-primary);opacity:0.4;"></span>
                  <span class="fm-pax-name" style="font-style:italic;opacity:0.65;">${n === 1 ? 'Unnamed '+gender.toLowerCase() : n+' unnamed '+gender.toLowerCase()+'s'}</span>
                  <span class="fm-pax-meta">Identity not recorded in logbook</span>
                </div>`;
              }).join('')}
              ${named.length===0 && unnamedMatches.length===0 ? `<div style="font-size:0.8rem;color:var(--text-tertiary);font-style:italic;padding:0.5rem 0;">No passenger names recorded for this leg</div>` : ''}
            </div>
            <div class="fm-manifest-footer">
              <span>${f.tail_number} · ${f.aircraft_type||'Private Aircraft'}</span>
              ${f.notes ? `<span class="fm-notes">${f.notes}</span>` : ''}
            </div>
          </div>
        </div>`;

      return `
        <div class="fm-row" onclick="toggleFlight('${f.id}')" id="fm-row-${f.id}">
          <div class="fm-row-main">
            <span class="fm-date">${fmt(f.flight_date)}</span>
            <span class="fm-route">
              <span class="fm-airport">${f.origin}</span>
              <span class="fm-arrow-route">→</span>
              <span class="fm-airport">${f.destination}</span>
            </span>
            <span class="fm-city-names">${loc(f.origin)} → ${loc(f.destination)}</span>
            <span class="fm-badges">
              ${highlight ? `<span class="fm-badge-island">ISLAND</span>` : ''}
            </span>
            <span class="fm-pax-count">${named.length > 0 ? named.length+(unnamedMatches.length>0?'+':'') : unnamedMatches.length > 0 ? '?' : '—'} pax</span>
            <span class="fm-chevron" id="fm-chev-${f.id}">›</span>
          </div>
          ${manifestHtml}
        </div>`;
    }).join('');

    document.getElementById('tabProfiles').innerHTML = `
      <div style="padding:1.5rem 1.75rem;">
        <div style="margin-bottom:1.25rem;display:flex;align-items:flex-end;justify-content:space-between;gap:1rem;flex-wrap:wrap;">
          <div>
            <div class="subject-name" style="font-size:1.6rem;">Flight Manifests</div>
            <div style="font-family:'Montserrat',sans-serif;font-size:0.82rem;color:var(--text-tertiary);margin-top:0.25rem;letter-spacing:0.08em;">${(flights||[]).length} DOCUMENTED FLIGHT LEGS · N908JE & N909JE · PILOT LOGBOOK 1997–2005</div>
          </div>
          <div style="font-size:0.78rem;color:var(--text-secondary);">Click any flight to expand the full passenger manifest</div>
        </div>
        <div class="fm-list">${rowsHtml}</div>
        <div style="margin-top:1.5rem;padding:1rem;background:var(--surface);border-radius:8px;font-family:'Montserrat',sans-serif;font-size:0.62rem;color:var(--text-tertiary);line-height:1.8;letter-spacing:0.04em;">
          SOURCE: PILOT LOGBOOKS (DAVID RODGERS) · ENTERED INTO EVIDENCE UNITED STATES V. MAXWELL · USDC SDNY 2021<br>
          CLICK ANY FLIGHT ROW TO VIEW FULL PASSENGER MANIFEST AND LINKED PROFILES
        </div>
      </div>`;
  } catch(err) {
    document.getElementById('tabProfiles').innerHTML = `<div style="padding:1.5rem;"><div class="state-msg"><div class="state-label" style="color:#dc2626;">FLIGHT BROWSER ERROR: ${err.message || String(err)}</div></div></div>`;
  }
}

function toggleFlight(id) {
  const manifest = document.getElementById('fm-'+id);
  const row = document.getElementById('fm-row-'+id);
  const chev = document.getElementById('fm-chev-'+id);
  const isOpen = manifest.style.display !== 'none';
  manifest.style.display = isOpen ? 'none' : 'block';
  chev.style.transform = isOpen ? '' : 'rotate(90deg)';
  row.classList.toggle('fm-row-open', !isOpen);
}

function showLanding() {
  clearRightPanel();
  document.querySelector('.app').classList.add('landing-active');
  document.getElementById('tabProfiles').innerHTML = `
    <div class="landing">
      <div class="landing-title">Search the<br>Epstein DOJ Database</div>
      <div class="landing-sub">141 individuals indexed from the Epstein archive and pilot logbooks. Search by name to view profiles, flight history, connection analysis, and power index.</div>
      <div class="landing-suggestions">
        <span class="suggestion-chip" onclick="doSearch('Lesley Groff')">Lesley Groff</span>
        <span class="suggestion-chip" onclick="doSearch('Ghislaine Maxwell')">Ghislaine Maxwell</span>
        <span class="suggestion-chip" onclick="doSearch('Jean-Luc Brunel')">Jean-Luc Brunel</span>
        <span class="suggestion-chip" onclick="doSearch('Donald Trump')">Donald Trump</span>
        <span class="suggestion-chip" onclick="doSearch('Prince Andrew, Duke of York')">Prince Andrew</span>
        <span class="suggestion-chip" onclick="doSearch('Bill Gates')">Bill Gates</span>
        <span class="suggestion-chip" onclick="doSearch('Steve Bannon')">Steve Bannon</span>
        <span class="suggestion-chip" onclick="doSearch('Ehud Barak')">Ehud Barak</span>
        <span class="suggestion-chip" onclick="doSearch('Les Wexner')">Les Wexner</span>
        <span class="suggestion-chip" onclick="doSearch('Alan Dershowitz')">Alan Dershowitz</span>
        <span class="suggestion-chip" onclick="doSearch('Richard Branson')">Richard Branson</span>
        <span class="suggestion-chip" onclick="doSearch('Larry Summers')">Larry Summers</span>
        <span class="suggestion-chip" onclick="doSearch('Elon Musk')">Elon Musk</span>
        <span class="suggestion-chip" onclick="doSearch('Sarah Ferguson')">Sarah Ferguson</span>
      </div>
    </div>`;
}

function showProfilesLoading() {
  document.querySelector('.app').classList.remove('landing-active');
  document.getElementById('tabProfiles').innerHTML = `<div style="padding:1.5rem;"><div class="state-msg"><div class="state-label">QUERYING DATABASE...</div></div></div>`;
}
function showEmpty(query) {
  clearRightPanel();
  document.getElementById('tabProfiles').innerHTML = `<div style="padding:1.5rem;"><div class="state-msg"><div class="state-label">NO RESULTS FOR "${String(query).toUpperCase()}"</div><div class="state-sub">Try a different spelling, or browse by category using the filters.</div></div></div>`;
}
function showError(msg) {
  document.getElementById('tabProfiles').innerHTML = `<div style="padding:1.5rem;"><div class="state-msg"><div class="state-label" style="color:var(--unverified);">ERROR: ${msg}</div></div></div>`;
}
function clearRightPanel() {
  ['pw0','pw1','pw2','pw3'].forEach(id => { const el=document.getElementById(id); if(el) el.style.width='0%'; });
  ['pv0','pv1','pv2','pv3'].forEach(id => { const el=document.getElementById(id); if(el) el.textContent='—'; });
  ['powerPanel','coPresentPanel','locationsPanel','sourceDocsPanel',
   'flightStatsPanel','flightRoutesPanel','flightTravelersPanel',
   'connPanelA','connPanelB','connPathPanel'].forEach(id => { const el=document.getElementById(id); if(el) el.style.display='none'; });
}

// ── FLIGHT MANIFESTS sidebar ──
async function showFlightSidebarStats() {
  try {
    const [flightsRes, fpsRes, personsRes] = await Promise.all([
      db.from('flights').select('id,flight_date,origin,destination,tail_number'),
      db.from('flight_passengers').select('flight_id,person_id'),
      db.from('persons').select('id,full_name,category,relationship_to_epstein').eq('is_victim',false),
    ]);
    const flights = flightsRes.data || [];
    const fps = fpsRes.data || [];
    const persons = personsRes.data || [];
    const pById = {}; persons.forEach(p => pById[p.id] = p);

    // Archive stats
    const years = flights.map(f => f.flight_date.substring(0,4)).sort();
    const tails = [...new Set(flights.map(f=>f.tail_number).filter(Boolean))];
    const islandCodes = ['TIST','MYEF','MBPV','TNCM','MYNN'];
    const islandFlights = flights.filter(f => islandCodes.includes(f.destination) || islandCodes.includes(f.origin));
    document.getElementById('flightStatsPanel').style.display = 'block';
    document.getElementById('flightStatsContent').innerHTML = `
      <div class="source-doc-row"><div><div class="source-doc-id">${flights.length}</div><div class="source-doc-meta">Total flight legs</div></div></div>
      <div class="source-doc-row"><div><div class="source-doc-id">${years[0]} – ${years[years.length-1]}</div><div class="source-doc-meta">Date range in archive</div></div></div>
      <div class="source-doc-row"><div><div class="source-doc-id">${tails.join(', ')}</div><div class="source-doc-meta">Tail numbers documented</div></div></div>
      <div class="source-doc-row" style="border:none"><div><div class="source-doc-id">${islandFlights.length}</div><div class="source-doc-meta">Flights to island destinations</div></div></div>`;

    // Most frequent routes
    const routeCount = {};
    const AL = {'TEB':'Teterboro','PBI':'Palm Beach','TIST':'St. Thomas','JFK':'JFK','EWR':'Newark','LGA':'LaGuardia','HPN':'White Plains','MIA':'Miami','LAX':'Los Angeles','VNY':'Van Nuys','BOS':'Boston','SAF':'Santa Fe','MYEF':'Great Exuma','MBPV':'Turks & Caicos','TNCM':'St. Maarten','MYNN':'Nassau','LFMN':'Nice','LFPB':'Paris','DCA':'Washington','MVY':'Vineyard','ASE':'Aspen','HTO':'East Hampton'};
    const ln = c => AL[c]||c;
    flights.forEach(f => { const key = f.origin+'→'+f.destination; routeCount[key] = (routeCount[key]||0)+1; });
    const topRoutes = Object.entries(routeCount).sort((a,b)=>b[1]-a[1]).slice(0,5);
    const maxR = topRoutes[0]?.[1]||1;
    document.getElementById('flightRoutesPanel').style.display = 'block';
    document.getElementById('flightRoutesContent').innerHTML = topRoutes.map(([route,count]) => {
      const [orig,dest] = route.split('→');
      const isIsland = islandCodes.includes(dest)||islandCodes.includes(orig);
      return `<div class="copresent-row">
        <div class="copresent-info">
          <div class="copresent-name" style="font-size:0.75rem;">${ln(orig)} → ${ln(dest)}</div>
          <div class="copresent-meta">${isIsland?'Island route':'Domestic route'}</div>
        </div>
        <div class="copresent-right">
          <div class="copresent-bar-wrap"><div class="copresent-bar-fill" style="width:${Math.round(count/maxR*100)}%"></div></div>
          <div class="copresent-count">${count}×</div>
        </div>
      </div>`;
    }).join('');

    // Most frequent travelers
    const travCount = {};
    fps.forEach(fp => { if(fp.person_id && pById[fp.person_id]) travCount[fp.person_id] = (travCount[fp.person_id]||0)+1; });
    const topTrav = Object.entries(travCount).sort((a,b)=>b[1]-a[1]).slice(0,5);
    const maxT = topTrav[0]?.[1]||1;
    document.getElementById('flightTravelersPanel').style.display = 'block';
    document.getElementById('flightTravelersContent').innerHTML = topTrav.map(([pid,count]) => {
      const p = pById[pid];
      const initials = p.full_name.split(' ').map(w=>w[0]).join('').substring(0,2).toUpperCase();
      return `<div class="copresent-row">
        <div class="copresent-avatar">${initials}</div>
        <div class="copresent-info">
          <div class="copresent-name" onclick="doSearch('${p.full_name.replace(/'/g,"\\'")}');switchTab('profiles')">${p.full_name}</div>
          <div class="copresent-meta">${cap(p.category||'')} · ${cap((p.relationship_to_epstein||'').replace(/_/g,' '))}</div>
        </div>
        <div class="copresent-right">
          <div class="copresent-bar-wrap"><div class="copresent-bar-fill" style="width:${Math.round(count/maxT*100)}%"></div></div>
          <div class="copresent-count">${count} flights</div>
        </div>
      </div>`;
    }).join('');
  } catch(e) { console.error('Flight sidebar error:', e); }
}

// ── CONNECTIONS sidebar ──
function connUpdateSidebar(personA, personB, pathResult) {
  const renderPersonCard = (p, panelId, contentId) => {
    if (!p) return;
    const panel = document.getElementById(panelId);
    const content = document.getElementById(contentId);
    const title = panel?.querySelector('.panel-card-title');
    if (!panel || !content || !title) return;
    title.textContent = p.full_name;
    const pw = [p.power_public_profile, p.power_institutional, p.power_network_centrality, p.power_corroboration];
    const labels = ['Public Profile','Institutional','Network Centrality','Corroboration'];
    content.innerHTML = pw.map((v,i) =>
      `<div class="power-row"><span class="power-label">${labels[i]}</span><div class="power-track"><div class="power-fill" style="width:${v||0}%"></div></div><span class="power-val">${v||'—'}</span></div>`
    ).join('') + `<div style="margin-top:0.6rem;padding-top:0.6rem;border-top:1px solid var(--border);">
      <div class="copresent-meta">${cap((p.relationship_to_epstein||'associate').replace(/_/g,' '))} · ${cap(p.category||'')}</div>
    </div>`;
    panel.style.display = 'block';
  };

  if (personA?.id) {
    db.from('persons').select('full_name,category,relationship_to_epstein,power_public_profile,power_institutional,power_network_centrality,power_corroboration').eq('id', personA.id).single()
      .then(({data}) => { if(data) renderPersonCard(data, 'connPanelA', 'connPanelAContent'); });
  }
  if (personB?.id) {
    db.from('persons').select('full_name,category,relationship_to_epstein,power_public_profile,power_institutional,power_network_centrality,power_corroboration').eq('id', personB.id).single()
      .then(({data}) => { if(data) renderPersonCard(data, 'connPanelB', 'connPanelBContent'); });
  }

  // Path summary
  if (pathResult) {
    const degrees = pathResult.nodePath.length - 1;
    const via = pathResult.nodePath.slice(1,-1);
    document.getElementById('connPathPanel').style.display = 'block';
    document.getElementById('connPathContent').innerHTML = `
      <div class="source-doc-row"><div><div class="source-doc-id">${degrees} degree${degrees!==1?'s':''}</div><div class="source-doc-meta">Separation between subjects</div></div></div>
      <div class="source-doc-row" style="border:none"><div><div class="source-doc-id">${pathResult.edgePath.length} shared connection${pathResult.edgePath.length!==1?'s':''}</div><div class="source-doc-meta">${via.length>0?'Via: '+via.map(id=>pathResult._pMap?.[id]?.full_name||'?').join(' → '):'Direct connection'}</div></div></div>`;
  }
}
function cap(str) { if (!str) return ''; return str.charAt(0).toUpperCase() + str.slice(1); }

// Handle ?search= and ?tab= params
(function() {
  const params = new URLSearchParams(window.location.search);
  const s = params.get('search');
  const t = params.get('tab');
  if (t) switchTab(t);
  if (s) { searchInput.value = s; doSearch(s); }
})();

// ════════════════════════════════════════
// ── UNIDENTIFIED TAB JS ──
// ════════════════════════════════════════

const AIRPORT_NAMES_U = {
  PBI:'Palm Beach', TEB:'Teterboro', JFK:'New York JFK', HPN:'Westchester',
  EWR:'Newark', MIA:'Miami', TIST:'St. Thomas / Little Saint James', LAX:'Los Angeles',
  VNY:'Van Nuys', MRY:'Monterey', CMH:'Columbus OH', ABY:'Albany GA',
  SAF:'Santa Fe', BOS:'Boston', MVY:"Martha's Vineyard", BED:'Bedford MA',
  ASE:'Aspen', IAD:'Washington Dulles', DCA:'Washington National',
  MYNN:'Nassau', MTPP:'Port-au-Prince', TNCM:'St. Maarten',
  RIC:'Richmond VA', HTO:'East Hampton', LAS:'Las Vegas',
  MDW:'Chicago Midway', OXC:'Waterbury CT', JAX:'Jacksonville',
};

function airportDisplay(code) { return AIRPORT_NAMES_U[code] || code; }
function nameSlug(name) { return encodeURIComponent(name); }

function parseRedacted(notes) {
  if (!notes) return [];
  const results = [];
  const matches = notes.matchAll(/(\d+)\s+(FEMALE|MALE)/gi);
  for (const m of matches) { results.push({ count: parseInt(m[1]), gender: m[2].toLowerCase() }); }
  if (notes.match(/\b1 FEMALE\b/i) && results.length === 0) { results.push({ count: 1, gender: 'female' }); }
  return results;
}

function redactedLabel(entry) {
  const word = entry.gender === 'female' ? 'FEMALE' : 'MALE';
  if (entry.count === 1) return `UNNAMED ${word}`;
  return `${entry.count} UNNAMED ${word}S`;
}

const PERSON_ROLES = {
  'Ghislaine Maxwell': 'Epstein associate · convicted',
  'Sarah Kellen': 'Epstein associate · charged',
  'Bill Clinton': '42nd President of the United States',
  'Jean-Luc Brunel': 'Model agent · died in custody 2022',
  'Nadia Marcinko': 'Epstein associate',
  'Johanna Sjoberg': 'Epstein accuser',
  'Alan Dershowitz': 'Attorney · accused in Giuffre suit',
  'Larry Summers': 'U.S. Treasury Secretary 1999–2001',
  'Prince Andrew, Duke of York': 'Duke of York · settled Giuffre suit 2022',
  'Sarah Ferguson': 'Duchess of York',
  'Glen Dubin': 'Hedge fund manager',
  'Eva Dubin': 'Physician · wife of Glen Dubin',
  'Gary Kerney': 'Epstein pilot',
};

async function initUnidentified() {
  const container = document.getElementById('uFlightContainer');
  try {
    const flightsRes = await db.from('flights').select('*').order('flight_date', { ascending: true });
    const flights = flightsRes.data || [];
    const fpRes = await db.from('flight_passengers').select('flight_id, person_id, name_as_logged, is_identified, is_redacted');
    const fps = fpRes.data || [];
    const personsRes = await db.from('persons').select('id, full_name, category');
    const persons = personsRes.data || [];
    const personMap = {};
    persons.forEach(p => personMap[p.id] = p);
    const fpByFlight = {};
    fps.forEach(fp => { if (!fpByFlight[fp.flight_id]) fpByFlight[fp.flight_id] = []; fpByFlight[fp.flight_id].push(fp); });
    const redactedFlights = flights.filter(f => {
      const fp2 = fpByFlight[f.id] || [];
      const hasRedacted = fp2.some(fp => fp.is_redacted);
      const notesHas = f.notes && /\d+\s+(FEMALE|MALE)/i.test(f.notes);
      return hasRedacted || notesHas;
    });
    if (redactedFlights.length === 0) { container.innerHTML = '<div class="loading-state">No records found.</div>'; return; }
    const totalUnnamed = redactedFlights.reduce((sum, f) => { const e = parseRedacted(f.notes || ''); return sum + e.reduce((s,x) => s+x.count, 0); }, 0);
    document.getElementById('statFlights').textContent = redactedFlights.length;
    document.getElementById('statPersons').textContent = totalUnnamed + '+';
    container.innerHTML = '';
    const clintonFlight = redactedFlights.find(f => f.flight_date === '2002-02-09');
    const otherFlights = redactedFlights.filter(f => f.flight_date !== '2002-02-09');
    if (clintonFlight) {
      const lbl = document.createElement('div'); lbl.className = 'section-label'; lbl.textContent = 'Most scrutinized entry'; container.appendChild(lbl);
      container.appendChild(buildUCard(clintonFlight, fpByFlight, personMap, true));
    }
    const allLbl = document.createElement('div'); allLbl.className = 'section-label'; allLbl.style.marginTop = '2rem'; allLbl.textContent = 'All documented instances'; container.appendChild(allLbl);
    otherFlights.forEach(f => container.appendChild(buildUCard(f, fpByFlight, personMap, false)));
    document.getElementById('uPatternBlock').style.display = 'block';
    document.getElementById('uSummarySection').style.display = 'block';
  } catch(err) {
    container.innerHTML = `<div class="loading-state">Error: ${err.message}</div>`;
  }
}

function buildUCard(flight, fpByFlight, personMap, isFeatured) {
  const fps = fpByFlight[flight.id] || [];
  const namedPassengers = fps.filter(fp => fp.is_identified && !fp.is_redacted && fp.person_id).map(fp => personMap[fp.person_id]).filter(Boolean);
  const unnamedEntries = parseRedacted(flight.notes || '');
  const totalUnnamed = unnamedEntries.reduce((s, e) => s + e.count, 0);
  const card = document.createElement('div');
  card.className = isFeatured ? 'featured-flight' : 'flight-card';
  const dateObj = new Date(flight.flight_date + 'T12:00:00');
  const dateStr = dateObj.toLocaleDateString('en-US', { year:'numeric', month:'long', day:'numeric' });
  const originName = airportDisplay(flight.origin);
  const destName = airportDisplay(flight.destination);
  let html = `
    ${isFeatured ? `<div class="featured-stamp">Notable flight</div>` : ''}
    <div class="flight-meta">
      <span class="flight-date">${dateStr}</span>
      <span class="flight-route"><span>${flight.origin}</span><span class="route-arrow">→</span><span>${flight.destination}</span></span>
      <span class="flight-route-name">${originName} → ${destName}</span>
      <span class="unknown-count-pill">${totalUnnamed} unnamed</span>
    </div>
    <div class="manifest-label">Passenger manifest — as logged</div>
    <div class="passenger-list">
  `;
  namedPassengers.forEach(p => {
    const role = PERSON_ROLES[p.full_name] || '';
    const link = `?search=${nameSlug(p.full_name)}`;
    html += `<div class="passenger-row"><span class="passenger-dot"></span><span class="passenger-name"><a href="${link}" onclick="doSearch('${p.full_name.replace(/'/g,"\\'")}');return false;">${p.full_name}</a></span>${role ? `<span class="passenger-role">${role}</span>` : ''}</div>`;
  });
  if (flight.notes && /\bJE\b/.test(flight.notes)) {
    const hasEpstein = namedPassengers.some(p => p.full_name.includes('Epstein'));
    if (!hasEpstein) html += `<div class="passenger-row"><span class="passenger-dot"></span><span class="passenger-name">Jeffrey Epstein</span><span class="passenger-role">Convicted sex offender</span></div>`;
  }
  if (namedPassengers.length > 0 || /\bJE\b/.test(flight.notes || '')) html += `<div class="manifest-divider"></div>`;
  unnamedEntries.forEach(entry => {
    html += `<div class="passenger-row redacted"><span class="passenger-dot"></span><span class="redacted-bar"><span class="redacted-label">${redactedLabel(entry)}</span><span class="redacted-count">logged as "${entry.count > 1 ? entry.count+' ' : ''}${entry.gender.toUpperCase()}${entry.count > 1 ? 'S' : ''}"</span></span></div>`;
  });
  html += `</div>`;
  const contextNotes = {
    '2002-02-09': "Clinton has stated he took four flights on Epstein's plane in 2002–2003. His spokesperson has never identified who the unnamed female passenger on this flight was.",
    '2005-02-03': 'This flight occurred three months before Palm Beach police opened their investigation into Epstein in May 2005. Jean-Luc Brunel died in a French prison in February 2022 while awaiting trial on rape charges.',
    '2002-01-17': "One of six flights in a rapid cluster (Jan–Apr 2002) carrying unnamed female passengers to St. Thomas, the island closest to Epstein's private island Little Saint James.",
    '1998-02-18': 'The earliest documented flight in this analysis carrying unnamed female passengers. Records from 1998 predate the criminal investigation by approximately seven years.',
  };
  if (contextNotes[flight.flight_date]) html += `<div class="context-note">${contextNotes[flight.flight_date]}</div>`;
  card.innerHTML = html;
  return card;
}

// ════════════════════════════════════════
// ── CONNECTIONS TAB JS ──
// ════════════════════════════════════════

let connAllPersons = [];
let connEdges = [];
let connAdjacency = {};
let connSelectedA = null;
let connSelectedB = null;
let connDataLoaded = false;

const AIRPORT_NAMES_C = {
  PBI:'Palm Beach', TEB:'Teterboro', JFK:'New York JFK', HPN:'Westchester',
  EWR:'Newark', MIA:'Miami', TIST:'St. Thomas', LAX:'Los Angeles',
  VNY:'Van Nuys', MRY:'Monterey', CMH:'Columbus OH', ABY:'Albany GA',
  SAF:'Santa Fe', BOS:'Boston', MVY:"Martha's Vineyard", BED:'Bedford MA',
  ASE:'Aspen', IAD:'Washington Dulles', DCA:'Washington National',
  MYNN:'Nassau', MTPP:'Port-au-Prince', TNCM:'St. Maarten',
  RIC:'Richmond VA', HTO:'East Hampton', LAS:'Las Vegas',
  MDW:'Chicago Midway', LFPB:'Paris Le Bourget', MYEF:'Staniel Cay',
  LPAZ:'Santa Cruz Bolivia', GMME:'Rabat Morocco', GMTT:'Tangier Morocco',
  EGBB:'Birmingham UK', EGGW:'London Luton', ESSA:'Stockholm', EIDW:'Dublin',
  LFML:'Marseille', LFMN:'Nice', BGR:'Bangor ME', MBPV:'Turks & Caicos',
};

function connRouteLabel(o, d) { return `${AIRPORT_NAMES_C[o]||o} → ${AIRPORT_NAMES_C[d]||d}`; }
function connCatClass(cat) { return cat ? `cat-${cat}` : 'cat-other'; }

async function initConnections() {
  const pRes = await db.from('persons').select('id, full_name, category, relationship_to_epstein, power_public_profile');
  connAllPersons = pRes.data || [];
  const personMap = {};
  connAllPersons.forEach(p => personMap[p.id] = p);

  const fpRes = await db.from('flight_passengers').select('flight_id, person_id, is_identified');
  const fps = fpRes.data || [];
  const fRes = await db.from('flights').select('id, flight_date, origin, destination');
  const flights = fRes.data || [];
  const flightMap = {};
  flights.forEach(f => flightMap[f.id] = f);

  const byFlight = {};
  fps.filter(fp => fp.is_identified).forEach(fp => { if (!byFlight[fp.flight_id]) byFlight[fp.flight_id] = []; byFlight[fp.flight_id].push(fp.person_id); });

  const flightEdgeMap = {};
  Object.entries(byFlight).forEach(([fid, pids]) => {
    const f = flightMap[fid]; if (!f) return;
    for (let i = 0; i < pids.length; i++) {
      for (let j = i+1; j < pids.length; j++) {
        const key = [pids[i],pids[j]].sort().join('|');
        if (!flightEdgeMap[key]) flightEdgeMap[key] = { flights: [] };
        flightEdgeMap[key].flights.push(f);
      }
    }
  });

  Object.entries(flightEdgeMap).forEach(([key, val]) => {
    const [a, b] = key.split('|');
    if (!personMap[a] || !personMap[b]) return;
    const count = val.flights.length;
    const sorted = val.flights.sort((x,y) => x.flight_date.localeCompare(y.flight_date));
    const first = sorted[0];
    const routes = [...new Set(sorted.map(f => connRouteLabel(f.origin, f.destination)))];
    const routeStr = routes.slice(0,2).join('; ')+(routes.length>2?` +${routes.length-2} more`:'');
    connEdges.push({ a, b, type:'flight', label: count===1?'1 documented flight together':`${count} documented flights together`, detail:`${first.flight_date} · ${routeStr}`, weight: count });
  });

  const epstein = { id:'__epstein__', full_name:'Jeffrey Epstein', category:'other', relationship_to_epstein:'subject' };
  const relLabels = { direct_contact:'Direct contact — documented in archive', employee:'Employee — documented in archive', alleged_client:'Alleged client — documented in archive', victim:'Documented survivor', legal_counsel:'Legal counsel — documented in archive', associate:'Associate — documented in archive' };
  connAllPersons.forEach(p => {
    const rel = p.relationship_to_epstein;
    if (!rel || rel === 'mentioned_only') return;
    connEdges.push({ a: p.id, b:'__epstein__', type:'relationship', label: relLabels[rel]||'Documented connection', detail:'Source: Epstein email archive and court records', weight:1 });
  });

  connAllPersons.push(epstein);
  personMap['__epstein__'] = epstein;

  connAllPersons.forEach(p => connAdjacency[p.id] = []);
  connEdges.forEach((e, i) => {
    if (connAdjacency[e.a] && connAdjacency[e.b]) {
      connAdjacency[e.a].push({ to: e.b, edgeIdx: i });
      connAdjacency[e.b].push({ to: e.a, edgeIdx: i });
    }
  });
  connDataLoaded = true;

  connSetupAutocomplete('connInputA', 'connDropA', p => {
    connSelectedA = p;
    document.getElementById('connFindBtn').disabled = !(connSelectedA && connSelectedB);
    connUpdateSidebar(connSelectedA, connSelectedB, null);
  });
  connSetupAutocomplete('connInputB', 'connDropB', p => {
    connSelectedB = p;
    document.getElementById('connFindBtn').disabled = !(connSelectedA && connSelectedB);
    connUpdateSidebar(connSelectedA, connSelectedB, null);
  });
}

function connBfs(startId, endId) {
  if (startId === endId) return null;
  const visited = new Set([startId]);
  const queue = [{ id: startId, path: [startId], edgePath: [] }];
  while (queue.length > 0) {
    const { id, path, edgePath } = queue.shift();
    for (const { to, edgeIdx } of (connAdjacency[id] || [])) {
      if (visited.has(to)) continue;
      const newPath = [...path, to];
      const newEdgePath = [...edgePath, edgeIdx];
      if (to === endId) return { nodePath: newPath, edgePath: newEdgePath };
      visited.add(to);
      queue.push({ id: to, path: newPath, edgePath: newEdgePath });
    }
  }
  return null;
}

function connFindAllPaths(startId, endId, maxPaths = 3) {
  if (startId === endId) return [];
  const shortest = connBfs(startId, endId);
  if (!shortest) return [];
  const targetLen = shortest.nodePath.length;
  const results = [shortest];
  for (let i = 0; i < shortest.edgePath.length && results.length < maxPaths; i++) {
    const blockedEdge = shortest.edgePath[i];
    const edgeData = connEdges[blockedEdge];
    const adjA = connAdjacency[edgeData.a];
    const adjB = connAdjacency[edgeData.b];
    const idxA = adjA.findIndex(x => x.edgeIdx === blockedEdge);
    const idxB = adjB.findIndex(x => x.edgeIdx === blockedEdge);
    if (idxA !== -1) adjA.splice(idxA, 1);
    if (idxB !== -1) adjB.splice(idxB, 1);
    const alt = connBfs(startId, endId);
    if (alt && alt.nodePath.length === targetLen) {
      const altKey = alt.nodePath.join('|');
      if (!results.some(r => r.nodePath.join('|') === altKey)) results.push(alt);
    }
    if (idxA !== -1) adjA.splice(idxA, 0, { to: edgeData.b, edgeIdx: blockedEdge });
    if (idxB !== -1) adjB.splice(idxB, 0, { to: edgeData.a, edgeIdx: blockedEdge });
  }
  return results;
}

function connGetPersonMap() { const m = {}; connAllPersons.forEach(p => m[p.id] = p); return m; }

function connRenderPath(result, pMap, isAlt) {
  const { nodePath, edgePath } = result;
  const degrees = nodePath.length - 1;
  const degClass = degrees === 1 ? 'deg-1' : degrees === 2 ? 'deg-2' : 'deg-3';
  const degLabel = degrees === 1 ? '1 degree of separation' : `${degrees} degrees of separation`;
  const aName = pMap[nodePath[0]]?.full_name || '?';
  const bName = pMap[nodePath[nodePath.length-1]]?.full_name || '?';
  const headline = degrees === 1 ? `${aName} and ${bName} are directly connected` : `${aName} → ${bName} in ${degrees} steps`;
  let html = `<div class="result-card"><div class="result-header"><span class="result-headline">${headline}</span><span class="degree-badge ${degClass}">${degLabel}</span></div><div class="path-viz">`;
  nodePath.forEach((pid, idx) => {
    const person = pMap[pid]; if (!person) return;
    const isFirst = idx === 0, isLast = idx === nodePath.length-1, isEndpoint = isFirst || isLast;
    const profileLink = pid === '__epstein__' ? `?search=Jeffrey+Epstein` : `?search=${encodeURIComponent(person.full_name)}`;
    html += `<div class="path-node"><div class="node-indicator"><div class="node-dot ${isEndpoint?'endpoint':''}">${isFirst?'A':isLast?'B':idx}</div>${!isLast?'<div class="node-line" style="min-height:40px;"></div>':''}</div><div class="node-content"><div class="node-name"><a href="${profileLink}" onclick="doSearch('${person.full_name.replace(/'/g,"\\'")}');return false;">${person.full_name}</a></div><div class="node-meta ${connCatClass(person.category)}">${person.category||'associate'}</div></div></div>`;
    if (idx < edgePath.length) {
      const edge = connEdges[edgePath[idx]];
      if (edge) {
        const isFlight = edge.type === 'flight';
        html += `<div class="path-edge"><div class="edge-indicator"><div class="edge-line-top"></div><div class="edge-icon">◆</div><div class="edge-line-bot"></div></div><div class="edge-content"><div class="edge-label ${isFlight?'flight-edge':''}"><span class="edge-dot"></span>${edge.label}</div><div class="edge-detail">${edge.detail}</div></div></div>`;
      }
    }
  });
  html += `</div></div>`;
  return html;
}

function connRenderResult(paths, pMap) {
  const area = document.getElementById('connResultArea');
  if (!paths || paths.length === 0) {
    area.innerHTML = `<div class="no-path"><div class="no-path-title">No documented connection found</div><div class="no-path-sub">These individuals do not share a documented flight or archive relationship within the current dataset.</div></div>`;
    return;
  }
  const primary = paths[0];
  const alts = paths.slice(1);
  let html = connRenderPath(primary, pMap, false);
  if (alts.length > 0) {
    const degrees = primary.nodePath.length - 1;
    let altHtml = `<div class="alt-paths"><div class="alt-title">Alternative paths — also ${degrees} degree${degrees!==1?'s':''}</div><div class="alt-list">`;
    alts.forEach(alt => {
      const midNames = alt.nodePath.slice(1,-1).map(pid => pMap[pid]?.full_name||'?');
      const label = midNames.length === 0 ? 'Direct connection' : `via ${midNames.join(' → ')}`;
      altHtml += `<div class="alt-item"><span class="alt-arrow">↳</span>${label}</div>`;
    });
    altHtml += `</div></div>`;
    html = html.replace('</div></div>', altHtml+'</div></div>');
  }
  area.innerHTML = html;
  area.querySelector('.result-card').style.animation = 'fadeUp 0.3s ease';
}

function connSetupAutocomplete(inputId, dropId, onSelect) {
  const input = document.getElementById(inputId);
  const drop = document.getElementById(dropId);
  let activeIdx = -1;
  function filter(query) {
    if (!query || query.length < 1) { drop.classList.remove('open'); return; }
    const q = query.toLowerCase();
    const matches = connAllPersons
      .filter(p => p.id !== '__epstein__' && p.full_name.toLowerCase().includes(q))
      .sort((a,b) => {
        const aS = a.full_name.toLowerCase().startsWith(q)?0:1;
        const bS = b.full_name.toLowerCase().startsWith(q)?0:1;
        if (aS !== bS) return aS-bS;
        return (b.power_public_profile||0)-(a.power_public_profile||0);
      }).slice(0,8);
    if (matches.length === 0) { drop.classList.remove('open'); return; }
    drop.innerHTML = matches.map((p,i) => `<div class="autocomplete-item" data-id="${p.id}" data-name="${p.full_name}" data-idx="${i}"><span class="autocomplete-name">${p.full_name}</span><span class="autocomplete-meta ${connCatClass(p.category)}">${p.category||'associate'} · ${p.relationship_to_epstein||''}</span></div>`).join('');
    drop.querySelectorAll('.autocomplete-item').forEach(el => {
      el.addEventListener('mousedown', e => { e.preventDefault(); input.value = el.dataset.name; drop.classList.remove('open'); onSelect({ id: el.dataset.id, full_name: el.dataset.name }); });
    });
    activeIdx = -1; drop.classList.add('open');
  }
  input.addEventListener('input', () => filter(input.value));
  input.addEventListener('focus', () => { if (input.value) filter(input.value); });
  input.addEventListener('blur', () => setTimeout(() => drop.classList.remove('open'), 150));
  input.addEventListener('keydown', e => {
    const items = drop.querySelectorAll('.autocomplete-item');
    if (e.key === 'ArrowDown') { e.preventDefault(); activeIdx = Math.min(activeIdx+1, items.length-1); items.forEach((el,i) => el.classList.toggle('active-item', i===activeIdx)); }
    else if (e.key === 'ArrowUp') { e.preventDefault(); activeIdx = Math.max(activeIdx-1, 0); items.forEach((el,i) => el.classList.toggle('active-item', i===activeIdx)); }
    else if (e.key === 'Enter' && activeIdx >= 0) { e.preventDefault(); const active = items[activeIdx]; if (active) { input.value = active.dataset.name; drop.classList.remove('open'); onSelect({ id: active.dataset.id, full_name: active.dataset.name }); } }
    else if (e.key === 'Escape') drop.classList.remove('open');
  });
}

function connFindPath() {
  if (!connSelectedA || !connSelectedB) return;
  if (connSelectedA.id === connSelectedB.id) {
    document.getElementById('connResultArea').innerHTML = `<div class="no-path"><div class="no-path-title">Same person selected</div><div class="no-path-sub">Please select two different individuals.</div></div>`;
    return;
  }
  const pMap = connGetPersonMap();
  const paths = connFindAllPaths(connSelectedA.id, connSelectedB.id);
  connRenderResult(paths, pMap);
  // Attach pMap to primary path for sidebar
  if (paths && paths.length > 0) { paths[0]._pMap = pMap; }
  connUpdateSidebar(connSelectedA, connSelectedB, paths?.[0] || null);
  document.getElementById('connResultArea').scrollIntoView({ behavior:'smooth', block:'start' });
}

function connSetQuick(nameA, nameB) {
  if (!connDataLoaded) return;
  const a = connAllPersons.find(p => p.full_name === nameA);
  const b = connAllPersons.find(p => p.full_name === nameB);
  if (!a || !b) return;
  document.getElementById('connInputA').value = nameA;
  document.getElementById('connInputB').value = nameB;
  connSelectedA = a; connSelectedB = b;
  document.getElementById('connFindBtn').disabled = false;
  connFindPath();
  connUpdateSidebar(connSelectedA, connSelectedB, null);
}

</script>
</body>
</html>
