<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Network Graph — The Reckoning Radar</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Montserrat:wght@400;500;600;700&family=Source+Sans+3:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
[data-theme="light"] {
  --bg: #F7F4EF;
  --bg-secondary: #EDE9E1;
  --surface: #FFFFFF;
  --border: rgba(0,0,0,0.08);
  --border-strong: rgba(0,0,0,0.14);
  --text-primary: #0D0D0D;
  --text-secondary: #4A4A4A;
  --text-tertiary: #888888;
  --accent: #1A1A1A;
}
[data-theme="dark"] {
  --bg: #0D0D0D;
  --bg-secondary: #141414;
  --surface: #1A1A1A;
  --border: rgba(255,255,255,0.08);
  --border-strong: rgba(255,255,255,0.14);
  --text-primary: #F0EDE8;
  --text-secondary: #A8A39B;
  --text-tertiary: #5A5550;
  --accent: #F0EDE8;
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  font-family: 'Source Sans 3', sans-serif;
  background: var(--bg);
  color: var(--text-primary);
  height: 100vh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

/* TOPBAR */
.topbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 1.5rem;
  height: 52px;
  background: var(--surface);
  border-bottom: 1px solid var(--border-strong);
  flex-shrink: 0;
  z-index: 100;
}
.logo-group {
  display: flex;
  flex-direction: column;
  line-height: 1;
}
.logo-the {
  font-family: 'DM Mono', monospace;
  font-size: 0.48rem;
  letter-spacing: 0.22em;
  color: var(--text-tertiary);
  text-transform: uppercase;
}
.logo-main {
  font-family: 'Montserrat', sans-serif;
  font-weight: 700;
  font-size: 1.1rem;
  letter-spacing: 0.04em;
  color: var(--text-primary);
}
.topbar-right {
  display: flex;
  align-items: center;
  gap: 1rem;
}
.back-btn {
  font-family: 'DM Mono', monospace;
  font-size: 0.65rem;
  letter-spacing: 0.08em;
  color: var(--text-tertiary);
  text-decoration: none;
  border: 1px solid var(--border-strong);
  padding: 5px 10px;
  border-radius: 4px;
  transition: all 0.15s;
}
.back-btn:hover { color: var(--text-primary); border-color: var(--text-primary); }

.theme-toggle {
  font-family: 'Montserrat', sans-serif;
  font-size: 0.68rem;
  font-weight: 500;
  color: var(--text-tertiary);
  background: none;
  border: 1px solid var(--border);
  padding: 4px 10px;
  border-radius: 4px;
  cursor: pointer;
}

.page-title {
  font-family: 'DM Mono', monospace;
  font-size: 0.62rem;
  letter-spacing: 0.12em;
  color: var(--text-tertiary);
  text-transform: uppercase;
}

/* LAYOUT */
.layout {
  display: flex;
  flex: 1;
  overflow: hidden;
}

/* CONTROLS SIDEBAR */
.controls {
  width: 220px;
  background: var(--surface);
  border-right: 1px solid var(--border);
  padding: 1rem;
  overflow-y: auto;
  flex-shrink: 0;
}
.ctrl-title {
  font-family: 'Montserrat', sans-serif;
  font-weight: 600;
  font-size: 0.72rem;
  letter-spacing: 0.1em;
  color: var(--text-tertiary);
  text-transform: uppercase;
  margin-bottom: 0.75rem;
  padding-bottom: 0.5rem;
  border-bottom: 1px solid var(--border);
}
.legend-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.45rem;
  font-size: 0.78rem;
  color: var(--text-secondary);
  cursor: pointer;
  padding: 3px 0;
  transition: color 0.15s;
}
.legend-item:hover { color: var(--text-primary); }
.legend-item.dimmed { opacity: 0.35; }
.legend-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  flex-shrink: 0;
}
.ctrl-sep { height: 1px; background: var(--border); margin: 1rem 0; }
.ctrl-label {
  font-family: 'DM Mono', monospace;
  font-size: 0.6rem;
  color: var(--text-tertiary);
  letter-spacing: 0.06em;
  margin-bottom: 0.4rem;
}
.filter-btn {
  display: block;
  width: 100%;
  text-align: left;
  padding: 5px 8px;
  margin-bottom: 4px;
  font-size: 0.75rem;
  color: var(--text-secondary);
  background: none;
  border: 1px solid var(--border);
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.15s;
  font-family: 'Source Sans 3', sans-serif;
}
.filter-btn:hover, .filter-btn.active {
  background: var(--accent);
  color: var(--bg);
  border-color: var(--accent);
}
.stat-row {
  font-family: 'DM Mono', monospace;
  font-size: 0.62rem;
  color: var(--text-tertiary);
  line-height: 2;
}

/* GRAPH AREA */
.graph-area {
  flex: 1;
  position: relative;
  overflow: hidden;
}

#graph-svg {
  width: 100%;
  height: 100%;
  cursor: grab;
}
#graph-svg:active { cursor: grabbing; }

/* TOOLTIP */
.tooltip {
  position: absolute;
  background: var(--surface);
  border: 1px solid var(--border-strong);
  border-radius: 8px;
  padding: 0.75rem 1rem;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.15s;
  max-width: 220px;
  z-index: 200;
  box-shadow: 0 4px 20px rgba(0,0,0,0.12);
}
.tooltip.visible { opacity: 1; }
.tt-name {
  font-family: 'Montserrat', sans-serif;
  font-weight: 600;
  font-size: 0.85rem;
  color: var(--text-primary);
  margin-bottom: 0.4rem;
  line-height: 1.3;
}
.tt-meta {
  font-family: 'DM Mono', monospace;
  font-size: 0.6rem;
  color: var(--text-tertiary);
  letter-spacing: 0.05em;
  line-height: 1.8;
}
.tt-hint {
  font-size: 0.65rem;
  color: var(--text-tertiary);
  margin-top: 0.4rem;
  font-style: italic;
}

/* PROFILE PANEL */
.profile-panel {
  position: absolute;
  top: 0;
  right: 0;
  width: 300px;
  height: 100%;
  background: var(--surface);
  border-left: 1px solid var(--border-strong);
  transform: translateX(100%);
  transition: transform 0.3s cubic-bezier(0.4,0,0.2,1);
  overflow-y: auto;
  z-index: 150;
  padding: 1.5rem;
}
.profile-panel.open { transform: translateX(0); }
.panel-close {
  position: absolute;
  top: 1rem;
  right: 1rem;
  background: none;
  border: none;
  font-size: 1.2rem;
  color: var(--text-tertiary);
  cursor: pointer;
  line-height: 1;
}
.panel-name {
  font-family: 'Montserrat', sans-serif;
  font-weight: 700;
  font-size: 1.2rem;
  color: var(--text-primary);
  margin-bottom: 0.5rem;
  margin-right: 1.5rem;
  line-height: 1.3;
}
.panel-title {
  font-size: 0.8rem;
  color: var(--text-secondary);
  margin-bottom: 1rem;
}
.panel-stat {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.5rem 0;
  border-bottom: 1px solid var(--border);
  font-size: 0.8rem;
}
.panel-stat-label { color: var(--text-tertiary); }
.panel-stat-val { font-weight: 600; color: var(--text-primary); }
.panel-link {
  display: block;
  margin-top: 1rem;
  padding: 0.6rem 1rem;
  background: var(--accent);
  color: var(--bg);
  text-decoration: none;
  border-radius: 6px;
  font-size: 0.78rem;
  font-weight: 600;
  text-align: center;
  font-family: 'Montserrat', sans-serif;
}
.panel-connections {
  margin-top: 1rem;
}
.panel-conn-title {
  font-family: 'DM Mono', monospace;
  font-size: 0.6rem;
  letter-spacing: 0.08em;
  color: var(--text-tertiary);
  margin-bottom: 0.5rem;
}
.panel-conn-item {
  font-size: 0.78rem;
  color: var(--text-secondary);
  padding: 3px 0;
  cursor: pointer;
  transition: color 0.15s;
}
.panel-conn-item:hover { color: var(--text-primary); }

/* LOADING */
.loading-overlay {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg);
  z-index: 300;
  flex-direction: column;
  gap: 1rem;
}
.loading-text {
  font-family: 'DM Mono', monospace;
  font-size: 0.72rem;
  color: var(--text-tertiary);
  letter-spacing: 0.12em;
}
.loading-sub {
  font-size: 0.75rem;
  color: var(--text-tertiary);
}

/* EDGE LABEL */
.edge-label {
  font-family: 'DM Mono', monospace;
  font-size: 0.55rem;
  fill: var(--text-tertiary);
  pointer-events: none;
}

@media (max-width: 600px) {
  .controls { display: none; }
  .profile-panel { width: 100%; }
}
</style>
</head>
<body>

<div class="topbar">
  <div class="logo-group">
    <span class="logo-the">THE</span>
    <span class="logo-main">Reckoning Radar</span>
  </div>
  <span class="page-title">Network Graph</span>
  <div class="topbar-right">
    <a href="index.html" class="back-btn">← BACK</a>
    <button class="theme-toggle" onclick="toggleTheme()">DARK</button>
  </div>
</div>

<div class="layout">
  <!-- CONTROLS -->
  <div class="controls">
    <div class="ctrl-title">Node Color</div>
    <div id="legend"></div>

    <div class="ctrl-sep"></div>
    <div class="ctrl-title">Filter</div>
    <div class="ctrl-label">Show connections</div>
    <button class="filter-btn active" id="filter-all" onclick="setFilter('all')">All relationships</button>
    <button class="filter-btn" id="filter-flights" onclick="setFilter('flights')">Flight co-travelers only</button>
    <button class="filter-btn" id="filter-direct" onclick="setFilter('direct')">Direct contacts only</button>

    <div class="ctrl-sep"></div>
    <div class="ctrl-title">Stats</div>
    <div class="stat-row" id="stats"></div>

    <div class="ctrl-sep"></div>
    <div class="ctrl-label">INSTRUCTIONS</div>
    <div style="font-size:0.72rem;color:var(--text-tertiary);line-height:1.7;">
      Drag to pan · Scroll to zoom · Click node to inspect · Drag node to reposition
    </div>
  </div>

  <!-- GRAPH -->
  <div class="graph-area">
    <div class="loading-overlay" id="loading">
      <div class="loading-text">BUILDING NETWORK...</div>
      <div class="loading-sub">Querying flight manifests and archive data</div>
    </div>
    <svg id="graph-svg"></svg>

    <!-- Tooltip -->
    <div class="tooltip" id="tooltip">
      <div class="tt-name" id="tt-name"></div>
      <div class="tt-meta" id="tt-meta"></div>
      <div class="tt-hint">Click to inspect</div>
    </div>

    <!-- Profile panel -->
    <div class="profile-panel" id="panel">
      <button class="panel-close" onclick="closePanel()">×</button>
      <div id="panel-content"></div>
    </div>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://gljuffkufkggynlaoyim.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdsanVmZmt1ZmtnZ3lubGFveWltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NDQxNzAsImV4cCI6MjA4NzUyMDE3MH0.TYRbhgiWOFp-Zc5LysfySLR8NeVQdZ9_zh6TpYyNQJE';
const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const CAT_COLORS = {
  finance:      '#2E6F40',
  politics:     '#FF2C2C',
  technology:   '#000080',
  legal:        '#FFEF00',
  academia:     '#2B1700',
  entertainment:'#FF5C00',
  royalty:      '#FFC8D3',
  media:        '#00B9B3',
  other:        '#FFA21F'
};

const REL_WEIGHTS = {
  direct_contact: 3,
  employee: 2,
  alleged_client: 2,
  legal_counsel: 2,
  associate: 1,
  victim: 1,
  mentioned_only: 0.5
};

let allNodes = [], allEdges = [], simulation, svg, g;
let currentFilter = 'all';
let activeNodeId = null;

function toggleTheme() {
  const html = document.documentElement;
  const isDark = html.dataset.theme === 'dark';
  html.dataset.theme = isDark ? 'light' : 'dark';
  document.querySelector('.theme-toggle').textContent = isDark ? 'DARK' : 'LIGHT';
}

function cap(s) { return s ? s.charAt(0).toUpperCase() + s.slice(1) : ''; }

async function loadData() {
  // 1. Get all persons
  const personsRes = await db
    .from('persons')
    .select('id, full_name, category, relationship_to_epstein, power_public_profile, confidence, current_status, total_document_count, public_title, notes')
    .eq('is_victim', false)
    .order('total_document_count', { ascending: false });
  const persons = personsRes.data || [];

  // 2. Get all identified flight passengers
  const fpsRes = await db
    .from('flight_passengers')
    .select('flight_id, person_id')
    .eq('is_identified', true);
  const fps = fpsRes.data || [];

  // Build co-flight edges in JS
  const flightMap = {};
  (fps || []).forEach(fp => {
    if (!flightMap[fp.flight_id]) flightMap[fp.flight_id] = [];
    flightMap[fp.flight_id].push(fp.person_id);
  });

  const edgeMap = {};
  Object.values(flightMap).forEach(passengers => {
    for (let i = 0; i < passengers.length; i++) {
      for (let j = i + 1; j < passengers.length; j++) {
        const a = passengers[i], b = passengers[j];
        const key = [a, b].sort().join('|');
        edgeMap[key] = (edgeMap[key] || 0) + 1;
      }
    }
  });

  const personIds = new Set((persons || []).map(p => p.id));

  // Build flight edges (only between known persons)
  const flightEdges = Object.entries(edgeMap)
    .filter(([key]) => {
      const [a, b] = key.split('|');
      return personIds.has(a) && personIds.has(b);
    })
    .map(([key, count]) => {
      const [source, target] = key.split('|');
      return { source, target, weight: count, type: 'flight', label: `${count} flight${count > 1 ? 's' : ''}` };
    });

  // Build relationship edges — connect everyone to Ghislaine/Epstein hub
  // Find Ghislaine as hub
  const ghislaine = (persons || []).find(p => p.full_name === 'Ghislaine Maxwell');
  const sarahK = (persons || []).find(p => p.full_name === 'Sarah Kellen');

  const relEdges = [];
  // Connect high-value direct contacts to Ghislaine
  const directContacts = (persons || []).filter(p =>
    p.relationship_to_epstein === 'direct_contact' && p.id !== ghislaine?.id
  );

  directContacts.forEach(p => {
    if (ghislaine && p.id !== ghislaine.id) {
      const key = [p.id, ghislaine.id].sort().join('|');
      // Only add if no flight edge exists
      if (!edgeMap[key]) {
        relEdges.push({ source: p.id, target: ghislaine.id, weight: 1.5, type: 'relationship', label: 'direct contact' });
      }
    }
  });

  // Connect associates with high email counts to Ghislaine or Sarah Kellen
  const highEmail = (persons || []).filter(p =>
    p.total_document_count > 5000 &&
    p.relationship_to_epstein !== 'direct_contact' &&
    p.id !== ghislaine?.id
  );

  highEmail.forEach(p => {
    const hub = sarahK || ghislaine;
    if (hub) {
      const key = [p.id, hub.id].sort().join('|');
      if (!edgeMap[key]) {
        relEdges.push({ source: p.id, target: hub.id, weight: 0.8, type: 'relationship', label: 'email contact' });
      }
    }
  });

  allNodes = (persons || []).map(p => ({
    ...p,
    id: p.id,
    flightCount: (fps || []).filter(fp => fp.person_id === p.id).length
  }));

  allEdges = [...flightEdges, ...relEdges];

  return { nodes: allNodes, edges: allEdges };
}

function buildLegend() {
  const leg = document.getElementById('legend');
  // Colors that need a border to be visible on light bg
  const darkColors = new Set(['#2B1700', '#253D2C', '#000080']);
  leg.innerHTML = Object.entries(CAT_COLORS).map(([cat, color]) => {
    const needsBorder = darkColors.has(color);
    const isYellow = color === '#FFEF00';
    const dotStyle = needsBorder
      ? `background:${color};border:1.5px solid var(--border-strong);`
      : isYellow
        ? `background:${color};border:1.5px solid rgba(0,0,0,0.2);`
        : `background:${color};`;
    return `
    <div class="legend-item" id="leg-${cat}" onclick="highlightCategory('${cat}')">
      <div class="legend-dot" style="${dotStyle}"></div>
      ${cap(cat)}
    </div>`;
  }).join('');
}

function updateStats(nodes, edges) {
  document.getElementById('stats').innerHTML = `
    <div>${nodes.length} individuals</div>
    <div>${edges.filter(e => e.type === 'flight').length} flight connections</div>
    <div>${edges.filter(e => e.type === 'relationship').length} archive links</div>
  `;
}

function buildGraph(nodes, edges) {
  const el = document.getElementById('graph-svg');
  const rect = el.getBoundingClientRect();
  const W = rect.width || el.parentElement.clientWidth || window.innerWidth - 220;
  const H = rect.height || el.parentElement.clientHeight || window.innerHeight - 52;
  console.log('Graph dimensions:', W, H, 'Nodes:', nodes.length, 'Edges:', edges.length);

  // Set explicit SVG dimensions as attributes (D3 needs these)
  d3.select('#graph-svg').attr('width', W).attr('height', H);
  svg = d3.select('#graph-svg');
  svg.selectAll('*').remove();

  // Zoom
  const zoom = d3.zoom()
    .scaleExtent([0.1, 4])
    .on('zoom', e => g.attr('transform', e.transform));
  svg.call(zoom);

  g = svg.append('g');

  // Arrow marker
  svg.append('defs').append('marker')
    .attr('id', 'arrow')
    .attr('viewBox', '0 -4 8 8')
    .attr('refX', 18)
    .attr('refY', 0)
    .attr('markerWidth', 5)
    .attr('markerHeight', 5)
    .attr('orient', 'auto')
    .append('path')
    .attr('d', 'M0,-4L8,0L0,4')
    .attr('fill', '#aaa');

  // Node radius scale
  const maxEmails = d3.max(nodes, d => d.total_document_count) || 230000;
  const rScale = d3.scaleSqrt()
    .domain([0, maxEmails])
    .range([6, 28]);

  // Build D3 data with flight boost
  const getR = d => {
    const base = rScale(d.total_document_count || 0);
    const flightBoost = Math.min(d.flightCount * 3, 12);
    return Math.max(base, 8) + flightBoost;
  };

  // Simulation
  simulation = d3.forceSimulation(nodes)
    .force('link', d3.forceLink(edges).id(d => d.id)
      .distance(d => d.type === 'flight' ? 80 + (3 - d.weight) * 20 : 140)
      .strength(d => d.type === 'flight' ? 0.5 : 0.15))
    .force('charge', d3.forceManyBody().strength(-220))
    .force('center', d3.forceCenter(W / 2, H / 2))
    .force('collision', d3.forceCollide().radius(d => getR(d) + 4));

  // Edges
  const link = g.append('g').attr('class', 'links')
    .selectAll('line')
    .data(edges)
    .join('line')
    .attr('stroke', d => d.type === 'flight' ? '#dc2626' : '#cccccc')
    .attr('stroke-width', d => d.type === 'flight' ? Math.min(d.weight * 1.5, 5) : 0.8)
    .attr('stroke-opacity', d => d.type === 'flight' ? 0.6 : 0.3)
    .attr('stroke-dasharray', d => d.type === 'relationship' ? '3,3' : null);

  // Edge labels (flight count)
  const linkLabel = g.append('g').attr('class', 'link-labels')
    .selectAll('text')
    .data(edges.filter(e => e.type === 'flight' && e.weight > 1))
    .join('text')
    .attr('class', 'edge-label')
    .attr('text-anchor', 'middle')
    .text(d => d.label);

  // Nodes
  const node = g.append('g').attr('class', 'nodes')
    .selectAll('g')
    .data(nodes)
    .join('g')
    .attr('class', 'node-group')
    .call(d3.drag()
      .on('start', dragstart)
      .on('drag', dragged)
      .on('end', dragend));

  // Node circles
  node.append('circle')
    .attr('r', d => getR(d))
    .attr('fill', d => CAT_COLORS[d.category] || '#FFA21F')
    .attr('fill-opacity', 0.92)
    .attr('stroke', d => {
      if (d.relationship_to_epstein === 'direct_contact') return '#dc2626';
      // Dark nodes get light stroke, yellow gets dark stroke
      const darkNodes = ['academia','technology'];
      if (darkNodes.includes(d.category)) return 'rgba(255,255,255,0.5)';
      if (d.category === 'legal') return 'rgba(0,0,0,0.3)';
      return 'white';
    })
    .attr('stroke-width', d => d.relationship_to_epstein === 'direct_contact' ? 2.5 : 1.5)
    .style('cursor', 'pointer')
    .on('mouseover', showTooltip)
    .on('mousemove', moveTooltip)
    .on('mouseout', hideTooltip)
    .on('click', (event, d) => { event.stopPropagation(); openPanel(d, nodes, edges); });

  // Flight indicator ring
  node.filter(d => d.flightCount > 0)
    .append('circle')
    .attr('r', d => getR(d) + 3)
    .attr('fill', 'none')
    .attr('stroke', '#dc2626')
    .attr('stroke-width', 1)
    .attr('stroke-opacity', 0.5)
    .attr('stroke-dasharray', '3,2')
    .style('pointer-events', 'none');

  // Node labels
  node.append('text')
    .attr('text-anchor', 'middle')
    .attr('dy', d => getR(d) + 12)
    .attr('font-family', 'Montserrat, sans-serif')
    .attr('font-size', d => {
      const r = getR(d);
      return r > 18 ? '10px' : r > 12 ? '9px' : '8px';
    })
    .attr('font-weight', d => d.power_public_profile > 70 ? '600' : '400')
    .attr('fill', 'var(--text-primary)')
    .attr('fill-opacity', 0.85)
    .style('pointer-events', 'none')
    .text(d => {
      const name = d.full_name;
      // Shorten long names
      if (name.length > 16) {
        const parts = name.split(' ');
        if (parts.length >= 2) return parts[0][0] + '. ' + parts[parts.length - 1];
      }
      return name;
    });

  // Simulation tick
  simulation.on('tick', () => {
    link
      .attr('x1', d => d.source.x)
      .attr('y1', d => d.source.y)
      .attr('x2', d => d.target.x)
      .attr('y2', d => d.target.y);

    linkLabel
      .attr('x', d => (d.source.x + d.target.x) / 2)
      .attr('y', d => (d.source.y + d.target.y) / 2);

    node.attr('transform', d => `translate(${d.x},${d.y})`);
  });

  // Click background to deselect
  svg.on('click', () => {
    closePanel();
    resetHighlight();
  });
}

function dragstart(event, d) {
  if (!event.active) simulation.alphaTarget(0.3).restart();
  d.fx = d.x; d.fy = d.y;
}
function dragged(event, d) { d.fx = event.x; d.fy = event.y; }
function dragend(event, d) {
  if (!event.active) simulation.alphaTarget(0);
  d.fx = null; d.fy = null;
}

function showTooltip(event, d) {
  const tt = document.getElementById('tooltip');
  document.getElementById('tt-name').textContent = d.full_name;
  document.getElementById('tt-meta').innerHTML = `
    ${cap(d.category)} · ${cap((d.relationship_to_epstein||'').replace(/_/g,' '))}<br>
    ${(d.total_document_count||0).toLocaleString()} emails · ${d.flightCount} documented flights<br>
    Power score: ${d.power_public_profile || 0}
  `;
  tt.classList.add('visible');
  moveTooltip(event);
}
function moveTooltip(event) {
  const tt = document.getElementById('tooltip');
  const x = event.clientX + 12;
  const y = event.clientY - 10;
  tt.style.left = Math.min(x, window.innerWidth - 240) + 'px';
  tt.style.top = Math.min(y, window.innerHeight - 120) + 'px';
}
function hideTooltip() {
  document.getElementById('tooltip').classList.remove('visible');
}

function openPanel(d, nodes, edges) {
  activeNodeId = d.id;
  // Highlight connected nodes
  highlightConnected(d.id, edges);

  const slug = (d.notes || '').match(/\[jwiki:([^\]]+)\]/)?.[1] || '';
  const connectedIds = new Set();
  edges.forEach(e => {
    const sid = typeof e.source === 'object' ? e.source.id : e.source;
    const tid = typeof e.target === 'object' ? e.target.id : e.target;
    if (sid === d.id) connectedIds.add(tid);
    if (tid === d.id) connectedIds.add(sid);
  });

  const connectedNames = nodes
    .filter(n => connectedIds.has(n.id))
    .sort((a, b) => (b.total_document_count || 0) - (a.total_document_count || 0))
    .slice(0, 8);

  document.getElementById('panel-content').innerHTML = `
    <div class="panel-name">${d.full_name}</div>
    <div class="panel-title">${d.public_title || cap(d.category || '')}</div>

    <div class="panel-stat">
      <span class="panel-stat-label">Category</span>
      <span class="panel-stat-val">${cap(d.category || 'Unknown')}</span>
    </div>
    <div class="panel-stat">
      <span class="panel-stat-label">Relationship</span>
      <span class="panel-stat-val">${cap((d.relationship_to_epstein||'').replace(/_/g,' '))}</span>
    </div>
    <div class="panel-stat">
      <span class="panel-stat-label">Emails in archive</span>
      <span class="panel-stat-val">${(d.total_document_count||0).toLocaleString()}</span>
    </div>
    <div class="panel-stat">
      <span class="panel-stat-label">Documented flights</span>
      <span class="panel-stat-val">${d.flightCount}</span>
    </div>
    <div class="panel-stat">
      <span class="panel-stat-label">Network connections</span>
      <span class="panel-stat-val">${connectedIds.size}</span>
    </div>
    <div class="panel-stat">
      <span class="panel-stat-label">Power index</span>
      <span class="panel-stat-val">${d.power_public_profile || 0} / 100</span>
    </div>
    <div class="panel-stat">
      <span class="panel-stat-label">Confidence</span>
      <span class="panel-stat-val">${cap(d.confidence || 'indicated')}</span>
    </div>
    <div class="panel-stat">
      <span class="panel-stat-label">Status</span>
      <span class="panel-stat-val">${cap(d.current_status || 'Unknown')}</span>
    </div>

    ${connectedNames.length > 0 ? `
    <div class="panel-connections">
      <div class="panel-conn-title">CONNECTED TO</div>
      ${connectedNames.map(n => `
        <div class="panel-conn-item" onclick="focusNode('${n.id}')">→ ${n.full_name}</div>
      `).join('')}
    </div>
    ` : ''}

    <a href="index.html?search=${encodeURIComponent(d.full_name)}" class="panel-link" style="margin-top:1.5rem;">
      View Full Profile →
    </a>
    ${slug ? `<a href="https://jmail.world/wiki/${slug}" target="_blank" class="panel-link" style="margin-top:0.5rem;background:var(--bg-secondary);color:var(--text-primary);">
      View on jmail.world ↗
    </a>` : ''}
  `;

  document.getElementById('panel').classList.add('open');
}

function closePanel() {
  document.getElementById('panel').classList.remove('open');
  activeNodeId = null;
  resetHighlight();
}

function focusNode(id) {
  const node = allNodes.find(n => n.id === id);
  if (node) openPanel(node, allNodes, allEdges);
}

function highlightConnected(nodeId, edges) {
  const connected = new Set([nodeId]);
  edges.forEach(e => {
    const sid = typeof e.source === 'object' ? e.source.id : e.source;
    const tid = typeof e.target === 'object' ? e.target.id : e.target;
    if (sid === nodeId) connected.add(tid);
    if (tid === nodeId) connected.add(sid);
  });

  d3.selectAll('.node-group circle:first-child')
    .attr('fill-opacity', d => connected.has(d.id) ? 1 : 0.15)
    .attr('stroke-opacity', d => connected.has(d.id) ? 1 : 0.1);

  d3.selectAll('.node-group text')
    .attr('fill-opacity', d => connected.has(d.id) ? 1 : 0.1);

  d3.selectAll('.links line')
    .attr('stroke-opacity', d => {
      const sid = typeof d.source === 'object' ? d.source.id : d.source;
      const tid = typeof d.target === 'object' ? d.target.id : d.target;
      return (sid === nodeId || tid === nodeId) ? 0.9 : 0.05;
    });
}

function resetHighlight() {
  d3.selectAll('.node-group circle:first-child')
    .attr('fill-opacity', 0.85)
    .attr('stroke-opacity', 1);
  d3.selectAll('.node-group text').attr('fill-opacity', 0.85);
  d3.selectAll('.links line')
    .attr('stroke-opacity', d => d.type === 'flight' ? 0.6 : 0.3);
}

function highlightCategory(cat) {
  const items = document.querySelectorAll('.legend-item');
  items.forEach(el => el.classList.toggle('dimmed', el.id !== `leg-${cat}`));

  d3.selectAll('.node-group circle:first-child')
    .attr('fill-opacity', d => d.category === cat ? 1 : 0.1);
  d3.selectAll('.node-group text')
    .attr('fill-opacity', d => d.category === cat ? 1 : 0.05);
  d3.selectAll('.links line').attr('stroke-opacity', 0.05);
}

function setFilter(filter) {
  currentFilter = filter;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('filter-' + filter).classList.add('active');

  let visibleEdges;
  if (filter === 'flights') {
    visibleEdges = allEdges.filter(e => e.type === 'flight');
  } else if (filter === 'direct') {
    visibleEdges = allEdges.filter(e => {
      const sid = typeof e.source === 'object' ? e.source.id : e.source;
      const tid = typeof e.target === 'object' ? e.target.id : e.target;
      const sNode = allNodes.find(n => n.id === sid);
      const tNode = allNodes.find(n => n.id === tid);
      return sNode?.relationship_to_epstein === 'direct_contact' ||
             tNode?.relationship_to_epstein === 'direct_contact';
    });
  } else {
    visibleEdges = allEdges;
  }

  d3.selectAll('.links line')
    .attr('stroke-opacity', d => {
      const isVisible = visibleEdges.some(ve => {
        const vs = typeof ve.source === 'object' ? ve.source.id : ve.source;
        const vt = typeof ve.target === 'object' ? ve.target.id : ve.target;
        const ds = typeof d.source === 'object' ? d.source.id : d.source;
        const dt = typeof d.target === 'object' ? d.target.id : d.target;
        return vs === ds && vt === dt;
      });
      if (!isVisible) return 0;
      return d.type === 'flight' ? 0.6 : 0.3;
    });
}

// Handle search param from main page
function checkSearchParam() {
  const params = new URLSearchParams(window.location.search);
  const search = params.get('search');
  if (search) {
    setTimeout(() => {
      const node = allNodes.find(n => n.full_name === search);
      if (node) openPanel(node, allNodes, allEdges);
    }, 1500);
  }
}

async function init() {
  buildLegend();
  try {
    const { nodes, edges } = await loadData();
    if (!nodes || nodes.length === 0) {
      document.getElementById('loading').innerHTML = '<div class="loading-text">NO DATA RETURNED</div><div class="loading-sub">Check Supabase connection</div>';
      return;
    }
    // Wait for browser to fully paint layout before measuring SVG dimensions
    requestAnimationFrame(() => {
      setTimeout(() => {
        document.getElementById('loading').style.display = 'none';
        updateStats(nodes, edges);
        buildGraph(nodes, edges);
        checkSearchParam();
      }, 100);
    });
  } catch (err) {
    document.getElementById('loading').innerHTML = '<div class="loading-text">ERROR</div><div class="loading-sub">' + err.message + '</div>';
    console.error('Graph init error:', err);
  }
}

init();

// Redraw on resize
let resizeTimer;
window.addEventListener('resize', () => {
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(() => {
    if (allNodes.length > 0) {
      if (simulation) simulation.stop();
      buildGraph(allNodes, allEdges);
    }
  }, 300);
});
</script>
</body>
</html>
